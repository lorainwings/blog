<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx é…ç½®æµ…æ | Lorain&#39;s Diary</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/blog/base/hd-img.jpg">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/base/hd-img.jpg">
    <meta name="description" content="å±±ä¸­æ¨—æ å¹´å¹´åœ¨ & çœ‹å°½è¥¿é£æœ¨æ§¿èŠ±">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta http-quiv="pragma" cotent="no-cache">
    <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
    <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/blog/assets/css/0.styles.4a9580f2.css" as="style"><link rel="preload" href="/blog/assets/js/app.121f6a68.js" as="script"><link rel="preload" href="/blog/assets/js/3.8c44ca0e.js" as="script"><link rel="preload" href="/blog/assets/js/28.d8ebaaa5.js" as="script"><link rel="preload" href="/blog/assets/js/4.57980df9.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.930d1339.js"><link rel="prefetch" href="/blog/assets/js/11.cdeb8098.js"><link rel="prefetch" href="/blog/assets/js/12.c8cde42b.js"><link rel="prefetch" href="/blog/assets/js/13.a227fbb7.js"><link rel="prefetch" href="/blog/assets/js/14.6af4650a.js"><link rel="prefetch" href="/blog/assets/js/15.6eaa9661.js"><link rel="prefetch" href="/blog/assets/js/16.061f9c22.js"><link rel="prefetch" href="/blog/assets/js/17.45db52d8.js"><link rel="prefetch" href="/blog/assets/js/18.5f9597d2.js"><link rel="prefetch" href="/blog/assets/js/19.b4ea0dfc.js"><link rel="prefetch" href="/blog/assets/js/20.7f19d52d.js"><link rel="prefetch" href="/blog/assets/js/21.d8589558.js"><link rel="prefetch" href="/blog/assets/js/22.f566dc38.js"><link rel="prefetch" href="/blog/assets/js/23.b69d67c8.js"><link rel="prefetch" href="/blog/assets/js/24.643b50bd.js"><link rel="prefetch" href="/blog/assets/js/25.31cd7e03.js"><link rel="prefetch" href="/blog/assets/js/26.e8823c82.js"><link rel="prefetch" href="/blog/assets/js/27.a7430202.js"><link rel="prefetch" href="/blog/assets/js/29.4c8e906e.js"><link rel="prefetch" href="/blog/assets/js/30.ae43da30.js"><link rel="prefetch" href="/blog/assets/js/31.75349241.js"><link rel="prefetch" href="/blog/assets/js/32.9b6fe64e.js"><link rel="prefetch" href="/blog/assets/js/33.4259a063.js"><link rel="prefetch" href="/blog/assets/js/34.4e487b39.js"><link rel="prefetch" href="/blog/assets/js/35.da4727e1.js"><link rel="prefetch" href="/blog/assets/js/36.cd999bec.js"><link rel="prefetch" href="/blog/assets/js/37.3d9a9f24.js"><link rel="prefetch" href="/blog/assets/js/38.e4fa97e3.js"><link rel="prefetch" href="/blog/assets/js/39.8ba92439.js"><link rel="prefetch" href="/blog/assets/js/40.3e0a8f49.js"><link rel="prefetch" href="/blog/assets/js/41.55113ca5.js"><link rel="prefetch" href="/blog/assets/js/42.08e02830.js"><link rel="prefetch" href="/blog/assets/js/43.94613343.js"><link rel="prefetch" href="/blog/assets/js/44.00357a70.js"><link rel="prefetch" href="/blog/assets/js/45.555be71a.js"><link rel="prefetch" href="/blog/assets/js/46.03a26959.js"><link rel="prefetch" href="/blog/assets/js/47.b29d5306.js"><link rel="prefetch" href="/blog/assets/js/48.cd893ec3.js"><link rel="prefetch" href="/blog/assets/js/49.12210cfc.js"><link rel="prefetch" href="/blog/assets/js/5.5d055cab.js"><link rel="prefetch" href="/blog/assets/js/50.ddcb3929.js"><link rel="prefetch" href="/blog/assets/js/51.ec0a7d07.js"><link rel="prefetch" href="/blog/assets/js/52.73a630cf.js"><link rel="prefetch" href="/blog/assets/js/53.989d0b51.js"><link rel="prefetch" href="/blog/assets/js/6.5cf5829a.js"><link rel="prefetch" href="/blog/assets/js/7.46c43574.js"><link rel="prefetch" href="/blog/assets/js/8.97b71141.js"><link rel="prefetch" href="/blog/assets/js/9.5a3cc726.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.8f04fa7f.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.4a9580f2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Lorain's Diary</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/skills/" class="nav-link router-link-active">
  ğŸ“œå‰ç«¯æŠ€æœ¯
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  ğŸ“Šè®¡ç®—æœºåŸºç¡€
</a></div><div class="nav-item"><a href="/blog/life/" class="nav-link">
  ğŸ€å…¶ä»–è®°å½•
</a></div><div class="nav-item"><a href="https://github.com/lorainwings" target="_blank" rel="noopener noreferrer" class="nav-link external">
  â­ï¸Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/skills/" class="nav-link router-link-active">
  ğŸ“œå‰ç«¯æŠ€æœ¯
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  ğŸ“Šè®¡ç®—æœºåŸºç¡€
</a></div><div class="nav-item"><a href="/blog/life/" class="nav-link">
  ğŸ€å…¶ä»–è®°å½•
</a></div><div class="nav-item"><a href="https://github.com/lorainwings" target="_blank" rel="noopener noreferrer" class="nav-link external">
  â­ï¸Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JSè¯­è¨€åŸºç¡€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>H5åŠæ¡†æ¶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å‰ç«¯å·¥ç¨‹åŒ–</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å®‰å…¨åŠæ€§èƒ½ä¼˜åŒ–</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>æœåŠ¡ç«¯å…¥é—¨</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/æœåŠ¡å™¨æ¨é€.html" class="sidebar-link">æœåŠ¡å™¨æ¨é€</a></li><li><a href="/blog/skills/Crontab.html" class="sidebar-link">Crontab</a></li><li><a href="/blog/skills/æŸ¥çœ‹æ—¥å¿—.html" class="sidebar-link">æŸ¥çœ‹æ—¥å¿—</a></li><li><a href="/blog/skills/DockeræŒ‡å—.html" class="sidebar-link">Docker æŒ‡å—</a></li><li><a href="/blog/skills/DockerForV2ray.html" class="sidebar-link">Docker For V2ray</a></li><li><a href="/blog/skills/Nginxé…ç½®æµ…æ.html" class="active sidebar-link">Nginx é…ç½®æµ…æ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/skills/Nginxé…ç½®æµ…æ.html#æ¦‚å¿µ-ä½œç”¨" class="sidebar-link">æ¦‚å¿µ &amp; ä½œç”¨</a></li><li class="sidebar-sub-header"><a href="/blog/skills/Nginxé…ç½®æµ…æ.html#æ–‡ç« ç»“æ„" class="sidebar-link">æ–‡ç« ç»“æ„</a></li><li class="sidebar-sub-header"><a href="/blog/skills/Nginxé…ç½®æµ…æ.html#å¸¸ç”¨é…ç½®æŒ‡ä»¤" class="sidebar-link">å¸¸ç”¨é…ç½®æŒ‡ä»¤</a></li><li class="sidebar-sub-header"><a href="/blog/skills/Nginxé…ç½®æµ…æ.html#å•é¡µåº”ç”¨é…ç½®" class="sidebar-link">å•é¡µåº”ç”¨é…ç½®</a></li><li class="sidebar-sub-header"><a href="/blog/skills/Nginxé…ç½®æµ…æ.html#å¤šé¡µåº”ç”¨é…ç½®" class="sidebar-link">å¤šé¡µåº”ç”¨é…ç½®</a></li></ul></li><li><a href="/blog/skills/HTTPåè®®å¤‡å¿˜å½•.html" class="sidebar-link">HTTP åè®®</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx-é…ç½®æµ…æ"><a href="#nginx-é…ç½®æµ…æ" class="header-anchor">#</a> Nginx é…ç½®æµ…æ</h1> <h2 id="æ¦‚å¿µ-ä½œç”¨"><a href="#æ¦‚å¿µ-ä½œç”¨" class="header-anchor">#</a> æ¦‚å¿µ &amp; ä½œç”¨</h2> <p>Nginx æ˜¯ä¸€ä¸ªè½»é‡çº§ã€é«˜æ€§èƒ½ã€ç¨³å®šæ€§é«˜ã€å¹¶å‘æ€§å¥½çš„ HTTP å’Œåå‘ä»£ç†æœåŠ¡å™¨; å®ƒå…·æœ‰æœ‰å¾ˆå¤šéå¸¸ä¼˜è¶Šçš„ç‰¹æ€§, åº”ç”¨éå¸¸å¹¿æ³›</p> <ul><li><p>åå‘ä»£ç†</p></li> <li><p>è´Ÿè½½å‡è¡¡</p></li> <li><p>HTTP æœåŠ¡å™¨ï¼ˆåŒ…å«åŠ¨é™åˆ†ç¦»ï¼‰</p></li> <li><p>æ­£å‘ä»£ç†</p></li></ul> <h2 id="æ–‡ç« ç»“æ„"><a href="#æ–‡ç« ç»“æ„" class="header-anchor">#</a> æ–‡ç« ç»“æ„</h2> <p>æœ¬æ–‡å°†ä¸»è¦åˆ†æä¸€ä¸‹åœ¨ Web åº”ç”¨ä¸­çš„å¸¸ç”¨é…ç½®, ä¸ºäº†æ–¹ä¾¿é˜…è¯», ç¬”è€…å°†æ–‡ç« ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†:</p> <ul><li>å¸¸ç”¨é…ç½®æŒ‡ä»¤</li> <li>å•é¡µåº”ç”¨é…ç½®</li> <li>å¤šé¡µåº”ç”¨é…ç½®</li></ul> <h2 id="å¸¸ç”¨é…ç½®æŒ‡ä»¤"><a href="#å¸¸ç”¨é…ç½®æŒ‡ä»¤" class="header-anchor">#</a> å¸¸ç”¨é…ç½®æŒ‡ä»¤</h2> <ul><li>location</li></ul> <div class="custom-block tip"><p class="custom-block-title">æ¦‚å¿µ</p> <p>location å®ç°äº†å¯¹è¯·æ±‚çš„ç»†åˆ†å¤„ç†ï¼Œæœ‰äº› URI è¿”å›é™æ€å†…å®¹ï¼Œæœ‰äº›åˆ†å‘åˆ°åç«¯æœåŠ¡å™¨ç­‰, æ”¯æŒçš„è¯­æ³• <code>location [=|~|~*|^~|@] pattern { ... }</code>;</p></div> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># ä¿®é¥°ç¬¦ = : è¦æ±‚è·¯å¾„å®Œå…¨åŒ¹é…&lt;ç²¾ç¡®åŒ¹é…&gt;</span>
<span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span>abc <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment"># ä¿®é¥°ç¬¦ ~ : åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é…&lt;æ­£åˆ™åŒ¹é…&gt;</span>
<span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">^</span><span class="token operator">/</span>abcd$ <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment"># ä¿®é¥°ç¬¦ ~* : ä¸åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é…&lt;æ­£åˆ™åŒ¹é…&gt;</span>
<span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token operator">/</span>abcd$  <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment"># ä¿®é¥°ç¬¦ ^~ : åŒ¹é…æˆåŠŸç«‹åˆ»åœæ­¢&lt;å‰ç¼€åŒ¹é…&gt;</span>
<span class="token keyword">location</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">/</span>abcd  <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment"># æ— ä¿®é¥°ç¬¦  : æœ€é•¿åŒ¹é…&lt;å‰ç¼€åŒ¹é…&gt;</span>
<span class="token keyword">location</span> <span class="token operator">/</span>document <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>ä»¥ä¸Šå¤šä¸ªåŒ¹é…ç¬¦éƒ½æœ‰çš„æƒ…å†µä¸‹, åŒ¹é…ç¬¦çš„ä¼˜å…ˆçº§æ˜¯<strong>å…ˆç²¾ç¡®åŒ¹é…ï¼Œæ²¡æœ‰åˆ™æŸ¥æ‰¾å¸¦æœ‰ ^~çš„å‰ç¼€åŒ¹é…ï¼Œæ²¡æœ‰åˆ™è¿›è¡Œæ­£åˆ™åŒ¹é…ï¼Œæœ€åæ‰è¿”å›æœ€é•¿åŒ¹é…ä¸‹çš„å‰ç¼€åŒ¹é…ç»“æœ, å¤šä¸ªæœ€é•¿åŒ¹é…è§„åˆ™ç›¸åŒä»¥ä¹¦å†™é¡ºåºå…ˆå</strong></p> <p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥ç†è§£è¿™ä¸ªåŒ¹é…é¡ºåº</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>function <span class="token function">match</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">:</span>
  rv <span class="token operator">=</span> NULL

  <span class="token keyword">if</span> uri in exact_match<span class="token punctuation">:</span>
    <span class="token keyword">return</span> exact_match<span class="token punctuation">[</span>uri<span class="token punctuation">]</span>

  <span class="token keyword">if</span> uri in prefix_match<span class="token punctuation">:</span>
    <span class="token keyword">if</span> prefix_match<span class="token punctuation">[</span>uri<span class="token punctuation">]</span> is <span class="token string">'^~'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> prefix_match<span class="token punctuation">[</span>uri<span class="token punctuation">]</span>
    else<span class="token punctuation">:</span>
      rv <span class="token operator">=</span> prefix_match<span class="token punctuation">[</span>uri<span class="token punctuation">]</span> <span class="token operator">/</span><span class="token operator">/</span> æ³¨æ„è¿™é‡Œæ²¡æœ‰ <span class="token keyword">return</span>ï¼Œä¸”è¿™é‡Œæ˜¯æœ€é•¿åŒ¹é…

  <span class="token keyword">if</span> uri in regex_match<span class="token punctuation">:</span>
    <span class="token keyword">return</span> regex_match<span class="token punctuation">[</span>uri<span class="token punctuation">]</span> <span class="token operator">/</span><span class="token operator">/</span> æŒ‰æ–‡ä»¶ä¸­é¡ºåºï¼Œæ‰¾åˆ°å³è¿”å›
  <span class="token keyword">return</span> rv
</code></pre></div><ul><li>rewrite</li></ul> <div class="custom-block tip"><p class="custom-block-title">æ¦‚å¿µ &amp; è¯­æ³•</p> <p>rewrite å®ç°äº†ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼ˆPCREï¼‰æ”¹å˜è¯·æ±‚çš„ URIï¼Œè¿”å›é‡å®šå‘ï¼Œå¹¶æœ‰æ¡ä»¶åœ°é€‰æ‹©é…ç½®</p> <p><strong>è¯­æ³•:</strong> <span style="color:green;">rewrite regex replacement [flag]</span></p></div> <p>1- ä½œç”¨åŸŸ</p> <p><code>rewrite</code>çš„ä½œç”¨åŸŸå¯ä»¥å‡ºç°åœ¨ <code>server</code>, <code>location</code>, <code>if</code>å—</p> <p>2- åŒ¹é…é¡ºåº</p> <p><code>rewrite</code> è§„åˆ™ä¼˜å…ˆçº§:</p> <div class="language-ä¼˜å…ˆçº§ extra-class"><pre class="language-text"><code>æ‰§è¡Œserverå—çš„rewriteæŒ‡ä»¤ -&gt; æ‰§è¡ŒlocationåŒ¹é… -&gt; æ‰§è¡ŒæŒ‡å®šçš„locaitonä¸­çš„rewrite
</code></pre></div><p>3- flag é€‰é¡¹
<code>flag</code> æœ‰ä»¥ä¸‹å‡ ä¸ªé€‰é¡¹</p> <table><thead><tr><th>å­—æ®µ</th> <th>ä½œç”¨</th></tr></thead> <tbody><tr><td>last</td> <td>åœæ­¢ rewrite æ£€æµ‹,å¼€å§‹æœç´¢ä¸æ›´æ”¹åçš„ URI ç›¸åŒ¹é…çš„ location</td></tr> <tr><td>break</td> <td>åœæ­¢ rewrite æ£€æµ‹,è·³å‡ºä¸å†æ£€æµ‹</td></tr> <tr><td>redirect</td> <td>è¿”å› 302 ä¸´æ—¶é‡å®šå‘ï¼Œåœ°å€æ ä¼šæ˜¾ç¤ºè·³è½¬åçš„åœ°å€</td></tr> <tr><td>permanent</td> <td>è¿”å› 301 æ°¸ä¹…é‡å®šå‘ï¼Œåœ°å€æ ä¼šæ˜¾ç¤ºè·³è½¬åçš„åœ°å€ï¼ˆæµè§ˆå™¨ä¸‹æ¬¡ç›´æ¥è®¿é—®é‡å®šå‘åçš„åœ°å€</td></tr></tbody></table> <p>4- æ³¨æ„ç‚¹
<code>rewrite</code>åœ¨é…ç½®ä¸­, é‡å†™å­—ç¬¦ä¸², å¸¦ä¸Šåè®® http ä¸ä¸å¸¦åè®®å¤„ç†æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># ç¬¬ä¸€ç§æƒ…å†µ</span>
location / <span class="token punctuation">{</span>
    <span class="token comment"># å½“åŒ¹é… æ­£åˆ™è¡¨è¾¾å¼ /test1/(.*)æ—¶ è¯·æ±‚å°†è¢«ä¸´æ—¶é‡å®šå‘åˆ° http://www.$1.com</span>
    <span class="token comment"># ç›¸å½“äº flag å†™ä¸º redirect</span>
    rewrite /test1/<span class="token punctuation">(</span>.*<span class="token punctuation">)</span> http://www.<span class="token variable">$1</span>.com<span class="token punctuation">;</span>
    <span class="token builtin class-name">return</span> <span class="token number">200</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment"># åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ 127.0.0.1:8080/test1/baidu</span>
<span class="token comment"># åˆ™ä¸´æ—¶é‡å®šå‘åˆ° www.baidu.com</span>
<span class="token comment"># åé¢çš„ return æŒ‡ä»¤å°†æ²¡æœ‰æœºä¼šæ‰§è¡Œäº†</span>

<span class="token comment"># ç¬¬äºŒç§æƒ…å†µ</span>
location / <span class="token punctuation">{</span>
    rewrite /test1/<span class="token punctuation">(</span>.*<span class="token punctuation">)</span> www.<span class="token variable">$1</span>.com<span class="token punctuation">;</span>
    <span class="token builtin class-name">return</span> <span class="token number">200</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment"># å‘é€è¯·æ±‚å¦‚ä¸‹</span>
<span class="token comment"># curl 127.0.0.1:8080/test1/baidu</span>
<span class="token comment"># ok</span>

<span class="token comment"># æ­¤å¤„æ²¡æœ‰å¸¦http:// æ‰€ä»¥åªæ˜¯ç®€å•çš„é‡å†™ã€‚è¯·æ±‚çš„ uri ç”± /test1/baidu é‡å†™ä¸º www.baidu.com</span>
<span class="token comment"># å› ä¸ºä¼šé¡ºåºæ‰§è¡Œ rewrite æŒ‡ä»¤ æ‰€ä»¥ ä¸‹ä¸€æ­¥æ‰§è¡Œ return æŒ‡ä»¤ å“åº”äº† ok</span>
</code></pre></div><ul><li>try_files</li></ul> <div class="custom-block tip"><p class="custom-block-title">æ¦‚å¿µ</p> <p>try_files æŒ‡ä»¤æ˜¯æŒ‰é¡ºåºæ£€æµ‹æ–‡ä»¶çš„å­˜åœ¨æ€§,å¹¶ä¸”è¿”å›ç¬¬ä¸€ä¸ªæ‰¾åˆ°æ–‡ä»¶çš„å†…å®¹,å¦‚æœç¬¬ä¸€ä¸ªæ‰¾ä¸åˆ°å°±ä¼šè‡ªåŠ¨æ‰¾ç¬¬äºŒä¸ª,ä¾æ¬¡æŸ¥æ‰¾.å…¶å®ç°çš„æ˜¯å†…éƒ¨è·³è½¬.ä»¥ä¸‹ä¸¾ä¾‹è¯´æ˜:</p></div> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span>abc <span class="token punctuation">{</span>
  <span class="token comment"># æ£€æµ‹æ–‡ä»¶4.htmlå’Œ5.html,å¦‚æœå­˜åœ¨æ­£å¸¸æ˜¾ç¤º,ä¸å­˜åœ¨å°±å»æŸ¥æ‰¾@qweå€¼</span>
  <span class="token keyword">try_files</span> <span class="token operator">/</span><span class="token number">4.</span>html <span class="token operator">/</span><span class="token number">5.</span>html @qwe<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">location</span> @qwe  <span class="token punctuation">{</span>
  <span class="token comment"># è·³è½¬åˆ°ç™¾åº¦é¡µé¢</span>
  <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$   <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>add_header</li></ul> <div class="custom-block tip"><p class="custom-block-title">æ¦‚å¿µ</p> <p>add_header ä½œç”¨æ˜¯ç»™å“åº”åŠ ä¸Šä¸€ä¸ªå¤´ä¿¡æ¯(<code>å“åº”å¤´</code>),åœ¨ Web çš„å¸¸è§ç”¨æ³•æ˜¯è®¾ç½®æ§åˆ¶ç¼“å­˜,é…ç½®è·¨åŸŸç­‰ç›¸å…³ request header</p></div> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span>js<span class="token operator">|</span>css<span class="token operator">|</span>png<span class="token operator">|</span>jpg<span class="token operator">|</span>gif<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
    <span class="token keyword">add_header</span> Cache<span class="token operator">-</span>Control no<span class="token operator">-</span>store<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><ul><li>proxy_set_header</li></ul> <div class="custom-block tip"><p class="custom-block-title">æ¦‚å¿µ</p> <p>proxy_set_header å…è®¸é‡æ–°å®šä¹‰æˆ–æ·»åŠ å­—æ®µä¼ é€’ç»™ä»£ç†æœåŠ¡å™¨çš„è¯·æ±‚å¤´(<code>è¯·æ±‚å¤´</code>)ã€‚è¯¥å€¼å¯ä»¥åŒ…å«æ–‡æœ¬ã€å˜é‡å’Œå®ƒä»¬çš„ç»„åˆ</p></div> <p>åœ¨æ²¡æœ‰å®šä¹‰ proxy_set_header æ—¶ä¼šç»§æ‰¿ä¹‹å‰å®šä¹‰çš„å€¼ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸¤ä¸ªå­—æ®µè¢«é‡å®šä¹‰ï¼š</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$proxy_host</span><span class="token punctuation">;</span>
<span class="token keyword">proxy_set_header</span> Connection close<span class="token punctuation">;</span>
</code></pre></div><ul><li>proxy_cookie_domain &amp; proxy_cookie_path</li></ul> <div class="custom-block tip"><p class="custom-block-title">æ¦‚å¿µ</p> <p>ä»£ç†è·¨åŸŸæœåŠ¡ä¸­çš„ <code>Set-Cookie</code>, ä¾‹å¦‚ a.com è°ƒç”¨ b.com ä¸­çš„æœåŠ¡, b.com çš„æœåŠ¡ä¸­è®¾ç½®äº† <code>Set-Cookie:xxx; domain:b.com</code>,å¯¼è‡´ a.com æ— æ³•è®¾ç½® cookie</p></div> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">/</span>xxx<span class="token operator">/</span> <span class="token punctuation">{</span>
  <span class="token comment"># b.comå’Œa.coméƒ½å¯ä»¥ä½¿ç”¨regrexè¡¨ç¤º, eg: ~\.?b.com</span>
  <span class="token keyword">proxy_cookie_domain</span> b<span class="token punctuation">.</span>com a<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
  <span class="token comment"># ä»£ç† ä»¥/sub/ å¼€å¤´çš„è·¯å¾„æ‰èƒ½è®¿é—®cookie</span>
  <span class="token keyword">proxy_cookie_path</span> <span class="token operator">/</span>sub<span class="token operator">/</span> <span class="token operator">/</span><span class="token punctuation">;</span>
  <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>b<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>X-Forwarded-Proto</li></ul> <div class="custom-block tip"><p class="custom-block-title">æ¦‚å¿µ</p> <p>X-Forwarded-Proto æ˜¯ä¸€ä¸ªæ ‡å‡†çš„è¯·æ±‚å¤´, ç”¨äº <code>proxy_set_header</code>, è¡¨ç¤ºå®¢æˆ·ç«¯ä¸ä»£ç†æœåŠ¡å™¨æˆ–è€…è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥æ‰€é‡‡ç”¨çš„ä¼ è¾“åè®®(https/http)</p></div> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># ç”¨äºè§£å†³Set-Cookieä¸­samesite:none;secureå¯¼è‡´çš„æ— æ³•æˆåŠŸè®¾ç½®cookieçš„é—®é¢˜</span>
<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
  <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>Proto <span class="token variable">$scheme</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="å•é¡µåº”ç”¨é…ç½®"><a href="#å•é¡µåº”ç”¨é…ç½®" class="header-anchor">#</a> å•é¡µåº”ç”¨é…ç½®</h2> <p>å½“å‰å‰ç«¯ç•Œæ—©å·²è¢«å•é¡µåº”ç”¨ä¸€ç»Ÿå¤©ä¸‹äº†, <code>Nginx</code>åœ¨å•é¡µåº”ç”¨ä¸­çš„é…ç½®, ä¸»è¦æ˜¯é…ç½®ç¼“å­˜, è´Ÿè½½å‡è¡¡, åå‘ä»£ç†æ¥å£ç­‰ç­‰; ç¬”è€…å°±å°†åœ¨å®é™…åº”ç”¨çš„é…ç½®æ”¾åœ¨è¿™é‡Œå§</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>
<span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token keyword">server_name</span> host<span class="token punctuation">.</span>com<span class="token punctuation">;</span>

    <span class="token comment"># itemåå­—å¯ä»¥è‡ªå®šä¹‰</span>
    <span class="token comment"># æœ‰ä¸‰ç§é…ç½®æ–¹å¼</span>
    <span class="token keyword">upstream</span> host<span class="token punctuation">.</span>com <span class="token punctuation">{</span>
        <span class="token comment"># weightçš„å€¼è¶Šé«˜è¢«æ´¾å‘è¯·æ±‚çš„æ¦‚ç‡ä¹Ÿå°±è¶Šé«˜ï¼Œå¯ä»¥æ ¹æ®æœåŠ¡å™¨é…ç½®çš„ä¸åŒæ¥è®¾ç½®ã€‚</span>
        <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8882</span> weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8881</span> weight<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token comment"># downè¡¨ç¤ºä¸å‚ä¸è´Ÿè½½å‡è¡¡</span>
        <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8880</span> down<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">upstream</span> host<span class="token punctuation">.</span>com <span class="token punctuation">{</span>
        <span class="token comment"># æ ¹æ®å®¢æˆ·ç«¯IPæ¥åˆ†é…æœåŠ¡å™¨ï¼Œæ¯”å¦‚æˆ‘ç¬¬ä¸€æ¬¡è®¿é—®è¯·æ±‚è¢«æ´¾å‘ç»™äº†192.168.101.60è¿™å°æœåŠ¡å™¨,é‚£ä¹ˆæˆ‘ä¹‹åçš„è¯·æ±‚å°±éƒ½ä¼šå‘é€è¿™å°æœåŠ¡å™¨ä¸Šï¼Œ</span>
        <span class="token comment"># è¿™æ ·çš„è¯sessionå…±äº«çš„é—®é¢˜ä¹Ÿå°±è§£å†³äº†</span>
        <span class="token keyword">ip_hash</span><span class="token punctuation">;</span>
        <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8881</span><span class="token punctuation">;</span>
        <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8880</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">upstream</span> host<span class="token punctuation">.</span>com <span class="token punctuation">{</span>
        <span class="token comment"># æ ¹æ®æ·»åŠ çš„æœåŠ¡å™¨åˆ¤æ–­å“ªå°æœåŠ¡å™¨åˆ†çš„è¿æ¥æœ€å°‘å°±æŠŠè¯·æ±‚ç»™è°</span>
        least_conn<span class="token punctuation">;</span>
        <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8881</span>
        <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8880</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html<span class="token punctuation">;</span>
        <span class="token keyword">alias</span> <span class="token operator">/</span>home<span class="token operator">/</span>www<span class="token operator">/</span>bop<span class="token operator">/</span><span class="token punctuation">;</span>
        <span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span><span class="token operator">/</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html<span class="token punctuation">;</span>
        <span class="token keyword">add_header</span> Cache<span class="token operator">-</span>Control no<span class="token operator">-</span>store<span class="token punctuation">;</span>
        <span class="token comment"># itemæ˜¯åœ¨ä¸Šé¢å‘½åçš„</span>
        <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>host<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># é…ç½®æ¥å£ä»£ç†</span>
    <span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">/</span>api<span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token keyword">rewrite</span> <span class="token operator">/</span>api<span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token operator">/</span>$<span class="token number">1</span>  <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
        <span class="token comment"># proxy_set_header Host  $http_host;</span>
        <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>host<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">access_log</span> <span class="token operator">/</span>home<span class="token operator">/</span>logs<span class="token operator">/</span>nginx<span class="token operator">/</span>bop<span class="token punctuation">.</span>access<span class="token punctuation">.</span>log monitor buffer<span class="token operator">=</span><span class="token number">32</span>k flush<span class="token operator">=</span><span class="token number">5</span>s<span class="token punctuation">;</span>
    <span class="token keyword">error_log</span> <span class="token operator">/</span>home<span class="token operator">/</span>logs<span class="token operator">/</span>nginx<span class="token operator">/</span>bop<span class="token punctuation">.</span>error<span class="token punctuation">.</span>log<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="å¤šé¡µåº”ç”¨é…ç½®"><a href="#å¤šé¡µåº”ç”¨é…ç½®" class="header-anchor">#</a> å¤šé¡µåº”ç”¨é…ç½®</h2> <p>ä¹‹å‰å›¢é˜Ÿä¸“é—¨æ­å»ºäº†ä¸€ä¸ªåšæ´»åŠ¨çš„å¤šé¡µåº”ç”¨æ¡†æ¶, æœåŠ¡äºå„ä¸ªæ´»åŠ¨åº”ç”¨å¼€å‘, å…¶ä¸­å¤šé¡µåº”ç”¨çš„ Nginx æ˜ å°„äº†å„ä¸ªæ´»åŠ¨çš„<code>BaseUrl</code>, è¿™é‡Œæ”¾ä¸ªæœ€å…³é”®çš„éƒ¨åˆ†å§</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">/</span>detail <span class="token punctuation">{</span>
    <span class="token keyword">set</span> <span class="token variable">$first_path</span> $<span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">root</span> <span class="token operator">/</span>home<span class="token operator">/</span>www<span class="token operator">/</span>growth<span class="token operator">-</span>upgrade<span class="token operator">/</span>html<span class="token punctuation">;</span>
    <span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span><span class="token operator">/</span> <span class="token variable">$first_path</span><span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">-</span>e <span class="token variable">$request_filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">/</span><span class="token variable">$first_path</span><span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html last<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">set</span> <span class="token variable">$first_path</span> $<span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">set</span> <span class="token variable">$following_path</span> $<span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">root</span> <span class="token operator">/</span>home<span class="token operator">/</span>www<span class="token operator">/</span>growth<span class="token operator">-</span>upgrade<span class="token operator">/</span>html<span class="token punctuation">;</span>
    <span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span><span class="token operator">/</span> <span class="token variable">$first_path</span><span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">-</span>e <span class="token variable">$request_filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">/</span><span class="token variable">$first_path</span><span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html last<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">æ›´æ–°æ—¶é—´:</span> <span class="time">4/5/2021, 5:46:42 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/blog/skills/DockerForV2ray.html" class="prev">
        Docker For V2ray
      </a></span> <span class="next"><a href="/blog/skills/HTTPåè®®å¤‡å¿˜å½•.html">
        HTTP åè®®
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.121f6a68.js" defer></script><script src="/blog/assets/js/3.8c44ca0e.js" defer></script><script src="/blog/assets/js/28.d8ebaaa5.js" defer></script><script src="/blog/assets/js/4.57980df9.js" defer></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥ | Lorain&#39;s Diary</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/blog/base/hd-img.jpg">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/base/hd-img.jpg">
    <meta name="description" content="å±±ä¸­æ¨—æ å¹´å¹´åœ¨ & çœ‹å°½è¥¿é£æœ¨æ§¿èŠ±">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta http-quiv="pragma" cotent="no-cache">
    <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
    <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/blog/assets/css/0.styles.4a9580f2.css" as="style"><link rel="preload" href="/blog/assets/js/app.021feda6.js" as="script"><link rel="preload" href="/blog/assets/js/3.8c44ca0e.js" as="script"><link rel="preload" href="/blog/assets/js/42.12103f07.js" as="script"><link rel="preload" href="/blog/assets/js/4.57980df9.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.930d1339.js"><link rel="prefetch" href="/blog/assets/js/11.cdeb8098.js"><link rel="prefetch" href="/blog/assets/js/12.c8cde42b.js"><link rel="prefetch" href="/blog/assets/js/13.a227fbb7.js"><link rel="prefetch" href="/blog/assets/js/14.6af4650a.js"><link rel="prefetch" href="/blog/assets/js/15.6eaa9661.js"><link rel="prefetch" href="/blog/assets/js/16.061f9c22.js"><link rel="prefetch" href="/blog/assets/js/17.45db52d8.js"><link rel="prefetch" href="/blog/assets/js/18.5f9597d2.js"><link rel="prefetch" href="/blog/assets/js/19.b4ea0dfc.js"><link rel="prefetch" href="/blog/assets/js/20.7f19d52d.js"><link rel="prefetch" href="/blog/assets/js/21.d8589558.js"><link rel="prefetch" href="/blog/assets/js/22.f566dc38.js"><link rel="prefetch" href="/blog/assets/js/23.b69d67c8.js"><link rel="prefetch" href="/blog/assets/js/24.643b50bd.js"><link rel="prefetch" href="/blog/assets/js/25.31cd7e03.js"><link rel="prefetch" href="/blog/assets/js/26.e8823c82.js"><link rel="prefetch" href="/blog/assets/js/27.a7430202.js"><link rel="prefetch" href="/blog/assets/js/28.d8ebaaa5.js"><link rel="prefetch" href="/blog/assets/js/29.4c8e906e.js"><link rel="prefetch" href="/blog/assets/js/30.ae43da30.js"><link rel="prefetch" href="/blog/assets/js/31.75349241.js"><link rel="prefetch" href="/blog/assets/js/32.9b6fe64e.js"><link rel="prefetch" href="/blog/assets/js/33.4259a063.js"><link rel="prefetch" href="/blog/assets/js/34.4e487b39.js"><link rel="prefetch" href="/blog/assets/js/35.5844e768.js"><link rel="prefetch" href="/blog/assets/js/36.cd999bec.js"><link rel="prefetch" href="/blog/assets/js/37.3d9a9f24.js"><link rel="prefetch" href="/blog/assets/js/38.e4fa97e3.js"><link rel="prefetch" href="/blog/assets/js/39.8ba92439.js"><link rel="prefetch" href="/blog/assets/js/40.3e0a8f49.js"><link rel="prefetch" href="/blog/assets/js/41.55113ca5.js"><link rel="prefetch" href="/blog/assets/js/43.94613343.js"><link rel="prefetch" href="/blog/assets/js/44.00357a70.js"><link rel="prefetch" href="/blog/assets/js/45.555be71a.js"><link rel="prefetch" href="/blog/assets/js/46.03a26959.js"><link rel="prefetch" href="/blog/assets/js/47.b29d5306.js"><link rel="prefetch" href="/blog/assets/js/48.cd893ec3.js"><link rel="prefetch" href="/blog/assets/js/49.12210cfc.js"><link rel="prefetch" href="/blog/assets/js/5.5d055cab.js"><link rel="prefetch" href="/blog/assets/js/50.ddcb3929.js"><link rel="prefetch" href="/blog/assets/js/51.ec0a7d07.js"><link rel="prefetch" href="/blog/assets/js/52.73a630cf.js"><link rel="prefetch" href="/blog/assets/js/53.989d0b51.js"><link rel="prefetch" href="/blog/assets/js/6.5cf5829a.js"><link rel="prefetch" href="/blog/assets/js/7.46c43574.js"><link rel="prefetch" href="/blog/assets/js/8.97b71141.js"><link rel="prefetch" href="/blog/assets/js/9.5a3cc726.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.8f04fa7f.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.4a9580f2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Lorain's Diary</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/skills/" class="nav-link router-link-active">
  ğŸ“œå‰ç«¯æŠ€æœ¯
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  ğŸ“Šè®¡ç®—æœºåŸºç¡€
</a></div><div class="nav-item"><a href="/blog/life/" class="nav-link">
  ğŸ€å…¶ä»–è®°å½•
</a></div><div class="nav-item"><a href="https://github.com/lorainwings" target="_blank" rel="noopener noreferrer" class="nav-link external">
  â­ï¸Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/skills/" class="nav-link router-link-active">
  ğŸ“œå‰ç«¯æŠ€æœ¯
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  ğŸ“Šè®¡ç®—æœºåŸºç¡€
</a></div><div class="nav-item"><a href="/blog/life/" class="nav-link">
  ğŸ€å…¶ä»–è®°å½•
</a></div><div class="nav-item"><a href="https://github.com/lorainwings" target="_blank" rel="noopener noreferrer" class="nav-link external">
  â­ï¸Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JSè¯­è¨€åŸºç¡€</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>H5åŠæ¡†æ¶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å‰ç«¯å·¥ç¨‹åŒ–</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>å®‰å…¨åŠæ€§èƒ½ä¼˜åŒ–</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/æµè§ˆå™¨ç¼“å­˜.html" class="sidebar-link">æµè§ˆå™¨ç¼“å­˜</a></li><li><a href="/blog/skills/å‰ç«¯å®‰å…¨é˜²èŒƒ.html" class="sidebar-link">å‰ç«¯å®‰å…¨é˜²èŒƒ</a></li><li><a href="/blog/skills/Webæ€§èƒ½ä¼˜åŒ–.html" class="sidebar-link">Web æ€§èƒ½ä¼˜åŒ–</a></li><li><a href="/blog/skills/æ€§èƒ½ä¼˜åŒ–æ€»ç»“.html" class="sidebar-link">æ€§èƒ½ä¼˜åŒ–æ€»ç»“</a></li><li><a href="/blog/skills/å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥.html" class="active sidebar-link">å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/skills/å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥.html#å›½å†…ç›‘æ§å¹³å°" class="sidebar-link">å›½å†…ç›‘æ§å¹³å°</a></li><li class="sidebar-sub-header"><a href="/blog/skills/å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥.html#å¸¸è§çš„æ—¥å¿—åˆ†ç±»" class="sidebar-link">å¸¸è§çš„æ—¥å¿—åˆ†ç±»</a></li><li class="sidebar-sub-header"><a href="/blog/skills/å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥.html#ç½‘ç»œé€šä¿¡æ—¥å¿—" class="sidebar-link">ç½‘ç»œé€šä¿¡æ—¥å¿—</a></li><li class="sidebar-sub-header"><a href="/blog/skills/å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥.html#æ€§èƒ½æ•°æ®é‡‡é›†" class="sidebar-link">æ€§èƒ½æ•°æ®é‡‡é›†</a></li><li class="sidebar-sub-header"><a href="/blog/skills/å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥.html#ç”¨æˆ·è¡Œä¸ºæ—¥å¿—" class="sidebar-link">ç”¨æˆ·è¡Œä¸ºæ—¥å¿—</a></li><li class="sidebar-sub-header"><a href="/blog/skills/å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥.html#ç”¨æˆ·ä¿¡æ¯æ”¶é›†" class="sidebar-link">ç”¨æˆ·ä¿¡æ¯æ”¶é›†</a></li><li class="sidebar-sub-header"><a href="/blog/skills/å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥.html#é”™è¯¯å´©æºƒæ—¥å¿—" class="sidebar-link">é”™è¯¯å´©æºƒæ—¥å¿—</a></li><li class="sidebar-sub-header"><a href="/blog/skills/å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥.html#å…¶ä»–æ—¥å¿—" class="sidebar-link">å…¶ä»–æ—¥å¿—</a></li><li class="sidebar-sub-header"><a href="/blog/skills/å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥.html#å¦‚ä½•ä¸ŠæŠ¥" class="sidebar-link">å¦‚ä½•ä¸ŠæŠ¥</a></li><li class="sidebar-sub-header"><a href="/blog/skills/å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥.html#ä¸ŠæŠ¥çš„æªæ–½" class="sidebar-link">ä¸ŠæŠ¥çš„æªæ–½</a></li><li class="sidebar-sub-header"><a href="/blog/skills/å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥.html#å‚è€ƒå†…å®¹" class="sidebar-link">å‚è€ƒå†…å®¹</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>æœåŠ¡ç«¯å…¥é—¨</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥"><a href="#å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥" class="header-anchor">#</a> å‰ç«¯ç›‘æ§åŠä¸ŠæŠ¥</h1> <p>å‰ç«¯ä¸šåŠ¡è¶Šæ¥è¶Šå¤æ‚çš„ä»Šå¤©ï¼Œå³ä¾¿æœ¬åœ°åšå„ç§å„æ ·å……åˆ†çš„æµ‹è¯•ï¼Œä¾ç…§ caniuse æŠŠå…¼å®¹æ€§ä¹Ÿä¸€ä¸€å¤„ç†ï¼Œä¾ç„¶æ— æ³•ä¿è¯é¡µé¢å®Œå…¨æ­£å¸¸è¿è¡Œ, åŒæ—¶æˆ‘ä»¬ä¹Ÿä¸æ¸…æ¥šè¿è¡Œçš„çŠ¶å†µã€‚
å‰ç«¯çš„é¡µé¢è·Ÿè®¾å¤‡ã€æµè§ˆå™¨ã€ç½‘ç»œç¯å¢ƒã€ç”¨æˆ·æ“ä½œä¹ æƒ¯ç­‰ç­‰å„ç§å„æ ·çš„å› ç´ å¯†åˆ‡ç›¸å…³ã€‚å› æ­¤å‰ç«¯ç›‘æ§å¹¶ä¸ŠæŠ¥æ—¥å¿—åˆ°æ—¥å¿—æœåŠ¡å™¨æ˜¯ä¿è¯å¿«é€Ÿæ”¶é›†å’Œå¤„ç†é—®é¢˜çš„å¿…è¦æ‰‹æ®µã€‚</p> <ul><li><p>é¡µé¢åœ¨ç”¨æˆ·é‚£é‡Œè¿è¡Œï¼Œå¦‚æœ 10%çš„ç”¨æˆ·é¡µé¢å‡ºç°é—®é¢˜è€Œè‡ªå·±æœ¬åœ°æ²¡æœ‰åŠæ³•é‡ç°ï¼Ÿ</p></li> <li><p>å¦‚ä½•å…ˆä¸€æ­¥äº†è§£åˆ°å‰ç«¯å‡ºç°çš„é—®é¢˜ï¼Œè€Œä¸æ˜¯ç­‰ç”¨æˆ·åé¦ˆï¼Ÿ</p></li> <li><p>èƒ½ä¸èƒ½åƒæŸ¥çœ‹æœåŠ¡ç«¯æ—¥å¿—ä¸€æ ·æ¥å®šä½å‰ç«¯é¡µé¢è¿è¡Œçš„é—®é¢˜ï¼Ÿ</p></li></ul> <h2 id="å›½å†…ç›‘æ§å¹³å°"><a href="#å›½å†…ç›‘æ§å¹³å°" class="header-anchor">#</a> å›½å†…ç›‘æ§å¹³å°</h2> <p>å›½å†…å¸¸ç”¨çš„ç›‘æ§å¹³å°ä¸‹é¢å‡ ä¸ªè¿˜ä¸é”™, ä¸»è¦ç¼ºç‚¹å°±æ˜¯ä»·æ ¼äº†...</p> <ul><li><code>sentry</code> ï¼šä»ç›‘æ§é”™è¯¯ã€é”™è¯¯ç»Ÿè®¡å›¾è¡¨ã€å¤šé‡æ ‡ç­¾è¿‡æ»¤å’Œæ ‡ç­¾ç»Ÿè®¡åˆ°è§¦å‘å‘Šè­¦ï¼Œè¿™ä¸€æ•´å¥—éƒ½å¾ˆå®Œå–„ï¼Œå›¢é˜Ÿé¡¹ç›®éœ€è¦å……é’±ï¼Œè€Œä¸”æ•°æ®é‡è¶Šå¤§é’±è¶Šè´µ</li> <li><code>fundebug</code>ï¼šé™¤äº†ç›‘æ§é”™è¯¯ï¼Œè¿˜å¯ä»¥å½•å±ï¼Œä¹Ÿå°±æ˜¯è®°å½•é”™è¯¯å‘ç”Ÿçš„å‰å‡ ç§’ç”¨æˆ·çš„æ‰€æœ‰æ“ä½œï¼Œå‹ç¼©åçš„ä½“ç§¯åªæœ‰å‡ å KBï¼Œä½†æ“ä½œç•¥å¾®ç¹ç</li> <li><code>webfunny</code>ï¼šä¹Ÿæ˜¯å«æœ‰ç›‘æ§é”™è¯¯çš„åŠŸèƒ½ï¼Œå¯ä»¥æ”¯æŒåƒä¸‡çº§åˆ«æ—¥ PV é‡ï¼Œé¢å¤–çš„äº®ç‚¹æ˜¯å¯ä»¥è¿œç¨‹è°ƒè¯•ã€æ€§èƒ½åˆ†æï¼Œä¹Ÿå¯ä»¥ docker ç§æœ‰åŒ–éƒ¨ç½²ï¼ˆå…è´¹ï¼‰ï¼Œä¸šåŠ¡ä»£ç åŠ å¯†è¿‡</li></ul> <h2 id="å¸¸è§çš„æ—¥å¿—åˆ†ç±»"><a href="#å¸¸è§çš„æ—¥å¿—åˆ†ç±»" class="header-anchor">#</a> å¸¸è§çš„æ—¥å¿—åˆ†ç±»</h2> <ul><li>é¡µé¢åŠ API è¯·æ±‚å’Œå“åº”çŠ¶æ€(æˆåŠŸä¸å¦)åŠå“åº”æ—¶é•¿</li> <li>é¡µé¢æ€§èƒ½æ—¥å¿—(é¡µé¢è¿æ¥è€—æ—¶ã€é¦–æ¬¡æ¸²æŸ“æ—¶é—´ã€èµ„æºåŠ è½½è€—æ—¶ç­‰)</li> <li>é¡µé¢è¡Œä¸ºæ—¥å¿—(PV/UV ç­‰ç­‰)</li> <li>é¡µé¢é”™è¯¯æ—¥å¿—(JS æ‰§è¡Œæƒ…å†µ/JS é”™è¯¯æƒ…å†µ/ç½‘é¡µå´©æºƒ)</li> <li>é¡µé¢ä¸šåŠ¡æ—¥å¿—</li> <li>é¡µé¢è‡ªå®šä¹‰æ—¥å¿—</li></ul> <h2 id="ç½‘ç»œé€šä¿¡æ—¥å¿—"><a href="#ç½‘ç»œé€šä¿¡æ—¥å¿—" class="header-anchor">#</a> ç½‘ç»œé€šä¿¡æ—¥å¿—</h2> <h3 id="å¦‚ä½•ç›‘æ§å‰ç«¯æ¥å£è¯·æ±‚å‘¢"><a href="#å¦‚ä½•ç›‘æ§å‰ç«¯æ¥å£è¯·æ±‚å‘¢" class="header-anchor">#</a> å¦‚ä½•ç›‘æ§å‰ç«¯æ¥å£è¯·æ±‚å‘¢</h3> <p>ä¸€èˆ¬å‰ç«¯è¯·æ±‚éƒ½æ˜¯ç”¨ jquery çš„ ajax è¯·æ±‚ï¼Œä¹Ÿæœ‰ç”¨ fetch è¯·æ±‚çš„ï¼Œä»¥åŠå‰ç«¯æ¡†æ¶è‡ªå·±å°è£…çš„è¯·æ±‚ç­‰ç­‰ã€‚æ€»ä¹‹ä»–ä»¬å°è£…çš„æ–¹æ³•å„ä¸ç›¸åŒï¼Œä½†æ˜¯ä¸‡å˜ä¸ç¦»å…¶å®—ï¼Œä»–ä»¬éƒ½æ˜¯å¯¹æµè§ˆå™¨çš„è¿™ä¸ªå¯¹è±¡ window.XMLHttpRequest è¿›è¡Œäº†å°è£…ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦èƒ½å¤Ÿç›‘å¬åˆ°è¿™ä¸ªå¯¹è±¡çš„ä¸€äº›äº‹ä»¶ï¼Œå°±èƒ½å¤ŸæŠŠè¯·æ±‚çš„ä¿¡æ¯åˆ†ç¦»å‡ºæ¥ã€‚</p> <h3 id="å¦‚ä½•ç›‘å¬-ajax-è¯·æ±‚"><a href="#å¦‚ä½•ç›‘å¬-ajax-è¯·æ±‚" class="header-anchor">#</a> å¦‚ä½•ç›‘å¬ ajax è¯·æ±‚</h3> <p>å¦‚æœä½ ç”¨çš„ jqueryã€zeptoã€æˆ–è€…è‡ªå·±å°è£…çš„ ajax æ–¹æ³•ï¼Œå°±å¯ä»¥ç”¨å¦‚ä¸‹çš„æ–¹æ³•è¿›è¡Œç›‘å¬ã€‚æˆ‘ä»¬ç›‘å¬ XMLHttpRequest å¯¹è±¡çš„ä¸¤ä¸ªäº‹ä»¶ loadstartï¼Œ loadendã€‚ä½†æ˜¯ç›‘å¬çš„ç»“æœå¹¶ä¸æ˜¯åƒæˆ‘ä»¬æƒ³è±¡çš„é‚£ä¹ˆå®¹æ˜“ç†è§£ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹ ajaxLoadStartï¼ŒajaxLoadEnd çš„å›è°ƒæ–¹æ³•ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * é¡µé¢æ¥å£è¯·æ±‚ç›‘æ§
 */</span>
<span class="token keyword">function</span> <span class="token function">recordHttpLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ç›‘å¬ajaxçš„çŠ¶æ€</span>
  <span class="token keyword">function</span> <span class="token function">ajaxEventTrigger</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> ajaxEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      detail<span class="token operator">:</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>ajaxEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> oldXHR <span class="token operator">=</span> window<span class="token punctuation">.</span>XMLHttpRequest<span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">newXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> realXHR <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">oldXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    realXHR<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      <span class="token string">&quot;loadstart&quot;</span><span class="token punctuation">,</span>
      <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ajaxEventTrigger</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;ajaxLoadStart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token boolean">false</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    realXHR<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      <span class="token string">&quot;loadend&quot;</span><span class="token punctuation">,</span>
      <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ajaxEventTrigger</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;ajaxLoadEnd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token boolean">false</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ­¤å¤„çš„æ•è·çš„å¼‚å¸¸ä¼šè¿æ—¥å¿—æ¥å£ä¹Ÿä¸€èµ·æ•è·ï¼Œå¦‚æœæ—¥å¿—ä¸ŠæŠ¥æ¥å£å¼‚å¸¸äº†ï¼Œå°±ä¼šå¯¼è‡´æ­»å¾ªç¯äº†ã€‚</span>
    <span class="token comment">// realXHR.onerror = function () {</span>
    <span class="token comment">//   siftAndMakeUpMessage(&quot;Uncaught FetchError: Failed to ajax&quot;, WEB_LOCATION, 0, 0, {});</span>
    <span class="token comment">// }</span>
    <span class="token keyword">return</span> realXHR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> timeRecordArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span>XMLHttpRequest <span class="token operator">=</span> newXHR<span class="token punctuation">;</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;ajaxLoadStart&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> tempObj <span class="token operator">=</span> <span class="token punctuation">{</span>
      timeStamp<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      event<span class="token operator">:</span> e
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    timeRecordArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tempObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;ajaxLoadEnd&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> timeRecordArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>timeRecordArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>status <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> currentTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> url <span class="token operator">=</span> timeRecordArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>responseURL<span class="token punctuation">;</span>
        <span class="token keyword">var</span> status <span class="token operator">=</span> timeRecordArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>status<span class="token punctuation">;</span>
        <span class="token keyword">var</span> statusText <span class="token operator">=</span> timeRecordArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>statusText<span class="token punctuation">;</span>
        <span class="token keyword">var</span> loadTime <span class="token operator">=</span> currentTime <span class="token operator">-</span> timeRecordArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>timeStamp<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>url <span class="token operator">||</span> url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token constant">HTTP_UPLOAD_LOG_API</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> httpLogInfoStart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpLogInfo</span><span class="token punctuation">(</span>
          <span class="token constant">HTTP_LOG</span><span class="token punctuation">,</span>
          url<span class="token punctuation">,</span>
          status<span class="token punctuation">,</span>
          statusText<span class="token punctuation">,</span>
          <span class="token string">&quot;å‘èµ·è¯·æ±‚&quot;</span><span class="token punctuation">,</span>
          timeRecordArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span>
          <span class="token number">0</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpLogInfoStart<span class="token punctuation">.</span><span class="token function">handleLogInfo</span><span class="token punctuation">(</span><span class="token constant">HTTP_LOG</span><span class="token punctuation">,</span> httpLogInfoStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> httpLogInfoEnd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpLogInfo</span><span class="token punctuation">(</span>
          <span class="token constant">HTTP_LOG</span><span class="token punctuation">,</span>
          url<span class="token punctuation">,</span>
          status<span class="token punctuation">,</span>
          statusText<span class="token punctuation">,</span>
          <span class="token string">&quot;è¯·æ±‚è¿”å›&quot;</span><span class="token punctuation">,</span>
          currentTime<span class="token punctuation">,</span>
          loadTime
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpLogInfoEnd<span class="token punctuation">.</span><span class="token function">handleLogInfo</span><span class="token punctuation">(</span><span class="token constant">HTTP_LOG</span><span class="token punctuation">,</span> httpLogInfoEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å½“å‰è¯·æ±‚æˆåŠŸåå°±åœ¨æ•°ç»„ä¸­ç§»é™¤æ‰</span>
        timeRecordArray<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸€ä¸ªé¡µé¢ä¸Šä¼šæœ‰å¾ˆå¤šä¸ªè¯·æ±‚ï¼Œå½“ä¸€ä¸ªé¡µé¢å‘å‡ºå¤šä¸ªè¯·æ±‚çš„æ—¶å€™ï¼ŒajaxLoadStart äº‹ä»¶è¢«ç›‘å¬åˆ°ï¼Œä½†æ˜¯å´æ— æ³•åŒºåˆ†å‡ºæ¥åˆ°åº•å‘é€çš„æ˜¯å“ªä¸ªè¯·æ±‚ï¼Œåªè¿”å›äº†ä¸€ä¸ªå†…å®¹è¶…å¤šçš„äº‹ä»¶å¯¹è±¡ï¼Œè€Œä¸”äº‹ä»¶å¯¹è±¡çš„å†…å®¹å‡ ä¹å®Œå…¨ä¸€æ ·ã€‚å½“ ajaxLoadEnd äº‹ä»¶è¢«ç›‘å¬åˆ°çš„æ—¶å€™ï¼Œä¹Ÿä¼šè¿”å›ä¸€ä¸ªå†…å®¹è¶…å¤šçš„æ—¶é—´å¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™äº‹ä»¶å¯¹è±¡é‡ŒåŒ…å«äº†æ¥å£è¯·æ±‚çš„æ‰€æœ‰ä¿¡æ¯ã€‚å¹¸è¿çš„æ˜¯ï¼Œä¸¤ä¸ªå¯¹è±¡æ˜¯åŒä¸€ä¸ªå¼•ç”¨ï¼Œä¹Ÿå°±æ„å‘³ç€ï¼ŒajaxLoadStart å’Œ ajaxLoadEnd äº‹ä»¶è¢«æ•è·çš„æ—¶å€™ï¼Œä»–ä»¬ä½œç”¨çš„æ˜¯ç”¨ä¸€ä¸ªå¯¹è±¡ã€‚é‚£æˆ‘ä»¬å°±æœ‰åŠæ³•åˆ†æå‡ºæ¥äº†ã€‚</p> <p>å½“ ajaxLoadStart äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œæˆ‘ä»¬å°†å›è°ƒæ–¹æ³•ä¸­çš„äº‹ä»¶å¯¹è±¡å…¨éƒ½æ”¾è¿›æ•°ç»„ timeRecordArray é‡Œï¼Œå½“ ajaxLoadEnd å‘ç”Ÿçš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å»éå†è¿™ä¸ªæ•°æ®ï¼Œé‡åˆ°åˆè¿”å›ç»“æœçš„äº‹ä»¶å¯¹è±¡ï¼Œè¯´æ˜æ¥å£è¯·æ±‚å·²ç»å®Œæˆï¼Œè®°å½•ä¸‹æ¥ï¼Œå¹¶ä»æ•°ç»„ä¸­åˆ é™¤è¯¥äº‹ä»¶å¯¹è±¡ã€‚è¿™æ ·æˆ‘ä»¬å°±èƒ½å¤Ÿé€ä¸€åˆ†æå‡ºæ¥å£è¯·æ±‚çš„å†…å®¹äº†ã€‚</p> <h3 id="å¦‚ä½•ç›‘å¬-fetch-è¯·æ±‚"><a href="#å¦‚ä½•ç›‘å¬-fetch-è¯·æ±‚" class="header-anchor">#</a> å¦‚ä½•ç›‘å¬ fetch è¯·æ±‚</h3> <p>é€šè¿‡ç¬¬ä¸€ç§æ–¹æ³•ï¼Œå·²ç»èƒ½å¤Ÿç›‘å¬åˆ°å¤§éƒ¨åˆ†çš„ ajax è¯·æ±‚äº†ã€‚ç„¶è€Œï¼Œä½¿ç”¨ fetch è¯·æ±‚çš„äººè¶Šæ¥è¶Šå¤šï¼Œå› ä¸º fetch çš„é“¾å¼è°ƒç”¨å¯ä»¥è®©æˆ‘ä»¬æ‘†è„± ajax çš„åµŒå¥—åœ°ç‹±ï¼Œè¢«æ›´å¤šçš„äººæ‰€é’çã€‚å¥‡æ€ªçš„æ˜¯ï¼Œæˆ‘ç”¨ç¬¬ä¸€ç§æ–¹å¼ï¼Œå´æ— æ³•ç›‘å¬åˆ° fetch çš„è¯·æ±‚äº‹ä»¶ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> init<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
      status<span class="token operator">:</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">,</span>
      statusText<span class="token operator">:</span> xhr<span class="token punctuation">.</span>statusText<span class="token punctuation">,</span>
      headers<span class="token operator">:</span> <span class="token function">parseHeaders</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span><span class="token function">getAllResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>url <span class="token operator">=</span>
      <span class="token string">&quot;responseURL&quot;</span> <span class="token keyword">in</span> xhr
        <span class="token operator">?</span> xhr<span class="token punctuation">.</span>responseURL
        <span class="token operator">:</span> options<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;X-Request-URL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> body <span class="token operator">=</span> <span class="token string">&quot;response&quot;</span> <span class="token keyword">in</span> xhr <span class="token operator">?</span> xhr<span class="token punctuation">.</span>response <span class="token operator">:</span> xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>
    <span class="token keyword">typeof</span> request<span class="token punctuation">.</span>\_bodyInit <span class="token operator">===</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> request<span class="token punctuation">.</span>\_bodyInit
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>è¿™ä¸ªæ˜¯ fetch çš„ä¸€æ®µæºç ï¼Œ å¯ä»¥çœ‹åˆ°ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ª Promise, å¹¶æ–°å»ºäº†ä¸€ä¸ª XMLHttpRequest å¯¹è±¡ var xhr =newXMLHttpRequest()ã€‚ç”±äº fetch çš„ä»£ç æ˜¯å†…ç½®åœ¨æµè§ˆå™¨ä¸­çš„ï¼Œå®ƒå¿…ç„¶å…ˆç”¨ç›‘æ§ä»£ç æ‰§è¡Œï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨æ·»åŠ ç›‘å¬äº‹ä»¶çš„æ—¶å€™ï¼Œæ˜¯æ— æ³•ç›‘å¬ fetch é‡Œè¾¹çš„ XMLHttpRequest å¯¹è±¡çš„ã€‚æ€ä¹ˆåŠå‘¢ï¼Œæˆ‘ä»¬éœ€è¦é‡å†™ä¸€ä¸‹ fetch çš„ä»£ç ã€‚åªè¦åœ¨ç›‘æ§ä»£ç æ‰§è¡Œä¹‹åï¼Œæˆ‘ä»¬é‡å†™ä¸€ä¸‹ fetchï¼Œå°±å¯ä»¥æ­£å¸¸ç›‘å¬ä½¿ç”¨ fetch æ–¹å¼å‘é€çš„è¯·æ±‚äº†ã€‚å°±è¿™ä¹ˆç®€å• ï¼šï¼‰</p> <p>çœ‹ä¸€ä¸‹éœ€è¦ç›‘å¬çš„å­—æ®µï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">setCommonProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>happenTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>webMonitorId <span class="token operator">=</span> <span class="token constant">WEB</span>\_MONITOR\_ID<span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>simpleUrl <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span>\<span class="token punctuation">[</span><span class="token number">0</span>\<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;#&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>completeUrl <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">b64EncodeUnicode</span><span class="token punctuation">(</span>
 <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>customerKey <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">getCustomerKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">var</span> wmUserInfo <span class="token operator">=</span> localStorage<span class="token punctuation">.</span>wmUserInfo
 <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span>wmUserInfo<span class="token punctuation">)</span>
 <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>userId <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">b64EncodeUnicode</span><span class="token punctuation">(</span>wmUserInfo<span class="token punctuation">.</span>userId <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>firstUserParam <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">b64EncodeUnicode</span><span class="token punctuation">(</span>
 wmUserInfo<span class="token punctuation">.</span>firstUserParam <span class="token operator">||</span> <span class="token string">&quot;&quot;</span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>secondUserParam <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">b64EncodeUnicode</span><span class="token punctuation">(</span>
 wmUserInfo<span class="token punctuation">.</span>secondUserParam <span class="token operator">||</span> <span class="token string">&quot;&quot;</span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">HttpLogInfo</span><span class="token punctuation">(</span>
 <span class="token parameter">uploadType<span class="token punctuation">,</span>
 url<span class="token punctuation">,</span>
 status<span class="token punctuation">,</span>
 statusText<span class="token punctuation">,</span>
 statusResult<span class="token punctuation">,</span>
 currentTime<span class="token punctuation">,</span>
 loadTime</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">setCommonProperty</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>uploadType <span class="token operator">=</span> uploadType<span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>httpUrl <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">b64EncodeUnicode</span><span class="token punctuation">(</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>statusText <span class="token operator">=</span> statusText<span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>statusResult <span class="token operator">=</span> statusResult<span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>happenTime <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>loadTime <span class="token operator">=</span> loadTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ‰€æœ‰å·¥ä½œå‡†å¤‡å®Œæ¯•ï¼Œå¦‚æœæŠŠæ”¶é›†åˆ°çš„æ—¥å¿—ä»ä¸åŒçš„ç»´åº¦å±•ç°å‡ºæ¥ï¼Œæˆ‘å°±ä¸ç»†è¯´äº†ï¼Œç›´æ¥ä¸Šå›¾äº†ã€‚å¦‚æ­¤ï¼Œä¾¿èƒ½å¤Ÿå¯¹å‰ç«¯æ¥å£æŠ¥é”™çš„æƒ…å†µæœ‰ä¸€ä¸ªæ¸…æ™°çš„äº†è§£ï¼Œä¹Ÿèƒ½å¤Ÿå¿«é€Ÿçš„å‘ç°çº¿ä¸Šçš„é—®é¢˜ã€‚</p> <h2 id="æ€§èƒ½æ•°æ®é‡‡é›†"><a href="#æ€§èƒ½æ•°æ®é‡‡é›†" class="header-anchor">#</a> æ€§èƒ½æ•°æ®é‡‡é›†</h2> <div class="custom-block tip"><p class="custom-block-title">Performance</p> <p>Performance æ¥å£å¯ä»¥è·å–åˆ°å½“å‰é¡µé¢ä¸­ä¸æ€§èƒ½ç›¸å…³çš„ä¿¡æ¯ï¼Œå®ƒæ˜¯ High Resolution Time API çš„ä¸€éƒ¨åˆ†ï¼ŒåŒæ—¶ä¹Ÿèåˆäº† Performance Timeline APIã€Navigation Timing APIã€ User Timing API å’Œ Resource Timing APIã€‚</p></div> <p>å…¶ä¸­é‡‡é›†æ€§èƒ½æ•°æ®, ç”¨åˆ°çš„ API æ˜¯<code>window.performance.timing</code>, è¿™é‡Œç”¨ä¸¤å¼ å›¾æ¥å±•ç¤ºå¯¹åº”å…³ç³»å§</p> <p><img src="/blog/skills/images/performance-api.webp" alt="performance-api.webp"> <img src="/blog/skills/images/performance-level.webp" alt="performance-level.webp"></p> <p>ä¸ºäº†æ–¹ä¾¿å±•ç¤º, æˆ‘è¿™é‡Œå†ç”¨ä¸€ä¸ªå¯¹è±¡æ¥å±•ç¤º:</p> <div class="language-js extra-class"><pre class="language-js"><code>timing<span class="token operator">:</span> <span class="token punctuation">{</span>
 navigationStart<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

 unloadEventStart<span class="token operator">:</span> <span class="token number">1543806782523</span><span class="token punctuation">,</span>

 unloadEventEnd<span class="token operator">:</span> <span class="token number">1543806782523</span><span class="token punctuation">,</span>

 redirectStart<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>

 redirectEnd<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>

 fetchStart<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

 domainLookupStart<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

 domainLookupEnd<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

 connectStart<span class="token operator">:</span> <span class="token number">1543806782099</span><span class="token punctuation">,</span>

 connectEnd<span class="token operator">:</span> <span class="token number">1543806782227</span><span class="token punctuation">,</span>

 secureConnectionStart<span class="token operator">:</span> <span class="token number">1543806782162</span><span class="token punctuation">,</span>

 requestStart<span class="token operator">:</span> <span class="token number">1543806782241</span><span class="token punctuation">,</span>

 responseStart<span class="token operator">:</span> <span class="token number">1543806782516</span><span class="token punctuation">,</span>

 responseEnd<span class="token operator">:</span> <span class="token number">1543806782537</span><span class="token punctuation">,</span>

 domLoading<span class="token operator">:</span> <span class="token number">1543806782573</span><span class="token punctuation">,</span>

 domInteractive<span class="token operator">:</span> <span class="token number">1543806783203</span><span class="token punctuation">,</span>

 domContentLoadedEventStart<span class="token operator">:</span> <span class="token number">1543806783203</span><span class="token punctuation">,</span>

 domContentLoadedEventEnd<span class="token operator">:</span> <span class="token number">1543806783216</span><span class="token punctuation">,</span>

 domComplete<span class="token operator">:</span> <span class="token number">1543806783796</span><span class="token punctuation">,</span>

 loadEventStart<span class="token operator">:</span> <span class="token number">1543806783796</span><span class="token punctuation">,</span>

 loadEventEnd<span class="token operator">:</span> <span class="token number">1543806783802</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬å¸¸ç”¨åˆ°çš„è®¡ç®—å…¬å¼:</p> <div class="language-docs extra-class"><pre class="language-text"><code>redirect: timing.redirectEnd - timing.redirectStart,

dom: timing.domComplete - timing.domLoading,

load: timing.loadEventEnd - timing.navigationStart,

unload: timing.unloadEventEnd - timing.unloadEventStart,

request: timing.responseEnd - timing.requestStart,

time: new Date().getTime(),
</code></pre></div><h3 id="ç™½å±æ—¶é—´è®¡ç®—"><a href="#ç™½å±æ—¶é—´è®¡ç®—" class="header-anchor">#</a> ç™½å±æ—¶é—´è®¡ç®—</h3> <p>è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ—¶é—´å°±æ˜¯ç™½å±æ—¶é—´ï¼Œå®ƒæŒ‡ä»è¾“å…¥ç½‘å€ï¼Œåˆ°é¡µé¢å¼€å§‹æ˜¾ç¤ºå†…å®¹çš„æ—¶é—´ã€‚</p> <p>å°†ä»¥ä¸‹è„šæœ¬æ”¾åœ¨ <code>&lt;/head&gt;</code>å‰é¢å°±èƒ½è·å–ç™½å±æ—¶é—´ã€‚</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  whiteScreen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>navigationStart<span class="token punctuation">;</span>
  whiteScreen <span class="token operator">=</span>
    performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>domLoading <span class="token operator">-</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>navigationStart<span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="èµ„æºåŠ è½½æ—¶é—´è®¡ç®—"><a href="#èµ„æºåŠ è½½æ—¶é—´è®¡ç®—" class="header-anchor">#</a> èµ„æºåŠ è½½æ—¶é—´è®¡ç®—</h3> <p>é€šè¿‡ Â <code>window.performance.getEntriesByType('resource')</code>Â  è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è·å–ç›¸å…³èµ„æºï¼ˆjsã€cssã€img...ï¼‰çš„åŠ è½½æ—¶é—´ï¼Œå®ƒä¼šè¿”å›é¡µé¢å½“å‰æ‰€åŠ è½½çš„æ‰€æœ‰èµ„æºã€‚</p> <p><img src="/blog/skills/images/performance-resource.webp" alt="performance-resource"></p> <p>å®ƒä¸€èˆ¬åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªç±»å‹ï¼š</p> <ul><li>sciprt</li> <li>link</li> <li>img</li> <li>css</li> <li>fetch</li> <li>other</li> <li>xmlhttprequest</li></ul> <p>æˆ‘ä»¬åªéœ€ç”¨åˆ°ä»¥ä¸‹å‡ ä¸ªä¿¡æ¯ï¼š</p> <div class="language-docs extra-class"><pre class="language-text"><code>name:Â item.name,duration:Â item.duration.toFixed(2),size:Â item.transferSize,protocol:Â item.nextHopProtocol,
</code></pre></div><p>ç°åœ¨ï¼Œå†™å‡ è¡Œä»£ç æ¥æ”¶é›†è¿™äº›æ•°æ®ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">getPerformance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>performance<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> timing <span class="token punctuation">}</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">;</span>
  <span class="token keyword">const</span> performance <span class="token operator">=</span> <span class="token punctuation">{</span>
    redirect<span class="token operator">:</span> timing<span class="token punctuation">.</span>redirectEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>redirectStart<span class="token punctuation">,</span>
    whiteScreen<span class="token punctuation">,</span>
    dom<span class="token operator">:</span> timing<span class="token punctuation">.</span>domComplete <span class="token operator">-</span> timing<span class="token punctuation">.</span>domLoading<span class="token punctuation">,</span>
    load<span class="token operator">:</span> timing<span class="token punctuation">.</span>loadEventEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>navigationStart<span class="token punctuation">,</span>
    unload<span class="token operator">:</span> timing<span class="token punctuation">.</span>unloadEventEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>unloadEventStart<span class="token punctuation">,</span>
    request<span class="token operator">:</span> timing<span class="token punctuation">.</span>responseEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>requestStart<span class="token punctuation">,</span>
    time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> performance<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">getResources</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>performance<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span><span class="token function">getEntriesByType</span><span class="token punctuation">(</span><span class="token string">&quot;resource&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> resource <span class="token operator">=</span> <span class="token punctuation">{</span>
    xmlhttprequest<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    css<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    other<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    script<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    img<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    link<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    fetch<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> arry <span class="token operator">=</span> resource<span class="token punctuation">[</span>item<span class="token punctuation">.</span>initiatorType<span class="token punctuation">]</span><span class="token punctuation">;</span>
    arry <span class="token operator">&amp;&amp;</span>
      arry<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        name<span class="token operator">:</span> item<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        duration<span class="token operator">:</span> item<span class="token punctuation">.</span>duration<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        size<span class="token operator">:</span> item<span class="token punctuation">.</span>transferSize<span class="token punctuation">,</span>
        protocol<span class="token operator">:</span> item<span class="token punctuation">.</span>nextHopProtocol
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> resource<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="ç”¨æˆ·è¡Œä¸ºæ—¥å¿—"><a href="#ç”¨æˆ·è¡Œä¸ºæ—¥å¿—" class="header-anchor">#</a> ç”¨æˆ·è¡Œä¸ºæ—¥å¿—</h2> <p>å•çº¯æ”¶é›†é”™è¯¯ä¿¡æ¯æ˜¯å¯ä»¥æé«˜é”™è¯¯å®šä½çš„æ•ˆç‡ï¼Œä½†å¦‚æœå†é…åˆä¸Šç”¨æˆ·è¡Œä¸ºçš„è¯å°±é”¦ä¸Šæ·»èŠ±ï¼Œå®šä½é”™è¯¯çš„æ•ˆç‡å†ä¸Šä¸€å±‚ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥æ¸…æ™°çš„çœ‹åˆ°ç”¨æˆ·åšäº†å“ªäº›äº‹ï¼šè¿›äº†å“ªä¸ªé¡µé¢ =&gt; ç‚¹å‡»äº†å“ªä¸ªæŒ‰é’® =&gt; è§¦å‘äº†å“ªä¸ªæ¥å£ï¼š</p> <p><img src="/blog/skills/images/user-action.image" alt="breadcrumb"></p> <p>ç”¨æˆ·è¡Œä¸ºå‰ç«¯é¡µé¢å±•ç¤º</p> <h3 id="dom-äº‹ä»¶ä¿¡æ¯"><a href="#dom-äº‹ä»¶ä¿¡æ¯" class="header-anchor">#</a> DOM äº‹ä»¶ä¿¡æ¯</h3> <p><code>dom</code>äº‹ä»¶è·å–åŒ…æ‹¬å¾ˆå¤šï¼š<code>click</code>ã€<code>input</code>ã€<code>doubleClick</code>ç­‰ç­‰ï¼Œä¸€ç§ç›´æ¥åœ¨ window ä¸Šé¢ç›‘å¬ click äº‹ä»¶ï¼ˆæ³¨æ„ç¬¬ä¸‰ä¸ªå‚æ•°ä¸º<code>true</code>ï¼‰:</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>è¿˜æœ‰ä¸€ç§æ˜¯é€šè¿‡é‡å†™<code>window.addEventListener</code>çš„æ–¹å¼æ¥æˆªå–å¼€å‘è€…å¯¹ dom çš„ç›‘å¬äº‹ä»¶ã€‚</p> <h3 id="è·¯ç”±åˆ‡æ¢ä¿¡æ¯"><a href="#è·¯ç”±åˆ‡æ¢ä¿¡æ¯" class="header-anchor">#</a> è·¯ç”±åˆ‡æ¢ä¿¡æ¯</h3> <p>åœ¨å•é¡µåº”ç”¨ä¸­æœ‰ä¸¤ç§è·¯ç”±å˜æ¢ï¼š<strong>hashchange</strong>ã€<strong>history</strong></p> <ul><li><strong>history</strong></li></ul> <p>å½“æµè§ˆå™¨æ”¯æŒ<code>history</code>æ¨¡å¼æ—¶ï¼Œä¼šè¢«ä»¥ä¸‹ä¸¤ä¸ªäº‹ä»¶æ‰€å½±å“ï¼š<code>pushState</code>ã€<code>replaceState</code>ï¼Œä¸”è¿™ä¸¤ä¸ªäº‹ä»¶ä¸ä¼šè§¦å‘<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/onpopstate" target="_blank" rel="noopener noreferrer">onpopstate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>çš„å›è°ƒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç›‘å¬è¿™ä¸ªä¸‰ä¸ªäº‹ä»¶ï¼š</p> <p><img src="/blog/skills/images/pop-state.image" alt="onpopstate"></p> <p>onpopstate é‡å†™</p> <ul><li><strong>hashchange</strong></li></ul> <p>å½“æµè§ˆå™¨åªæ”¯æŒ<code>hashchange</code>æ—¶ï¼Œå°±éœ€è¦é‡å†™ hashchange:</p> <p><img src="/blog/skills/images/hashchange.image" alt="hashchange"></p> <p>hashchange é‡å†™</p> <h3 id="console-ä¿¡æ¯"><a href="#console-ä¿¡æ¯" class="header-anchor">#</a> console ä¿¡æ¯</h3> <p>æ­£å¸¸æƒ…å†µä¸‹æ­£å¼ç¯å¢ƒæ˜¯ä¸åº”è¯¥æœ‰<code>console</code>çš„ï¼Œé‚£ä¸ºä»€ä¹ˆè¦æ”¶é›†<code>console</code>çš„ä¿¡æ¯ï¼Ÿç¬¬ä¸€ï¼šéæ­£å¸¸æƒ…å†µä¸‹ï¼Œæ­£å¼ç¯å¢ƒæˆ–é¢„å‘ç¯å¢ƒä¹Ÿå¯èƒ½ä¼šæœ‰<code>console</code>ï¼Œç¬¬äºŒï¼šå¾ˆå¤šæ—¶å€™ä¹Ÿå¯ä»¥æŠŠ<code>sdk</code>æ”¾å…¥æµ‹è¯•ç¯å¢ƒä¸Šé¢è°ƒè¯•ã€‚æ‰€ä»¥æœ€ç»ˆè¿˜æ˜¯å†³å®šæ”¶é›†<code>console</code>ä¿¡æ¯ï¼Œä½†æ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™çš„ä¼ å‚æ¥å‘Šè¯‰<code>sdk</code>æ˜¯å¦ç›‘å¬<code>console</code>çš„ä¿¡æ¯æ”¶é›†ã€‚</p> <p><img src="/blog/skills/images/replace-console.image" alt="relaceConsole">
console é‡å†™</p> <h3 id="spa-åº”ç”¨-hack"><a href="#spa-åº”ç”¨-hack" class="header-anchor">#</a> SPA åº”ç”¨ Hack</h3> <p><code>window.performance</code>Â API æ˜¯æœ‰ç¼ºç‚¹çš„ï¼Œåœ¨ SPA åˆ‡æ¢è·¯ç”±æ—¶ï¼Œ<code>window.performance.timing</code>Â  çš„æ•°æ®ä¸ä¼šæ›´æ–°ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¦æƒ³åŠæ³•æ¥ç»Ÿè®¡åˆ‡æ¢è·¯ç”±åˆ°åŠ è½½å®Œæˆçš„æ—¶é—´ã€‚æ‹¿ Vue ä¸¾ä¾‹ï¼Œä¸€ä¸ªå¯è¡Œçš„åŠæ³•å°±æ˜¯åˆ‡æ¢è·¯ç”±æ—¶ï¼Œåœ¨è·¯ç”±çš„å…¨å±€å‰ç½®å®ˆå« Â <code>beforeEach</code>Â  é‡Œè·å–å¼€å§‹æ—¶é—´ï¼Œåœ¨ç»„ä»¶çš„ Â <code>mounted</code>Â  é’©å­é‡Œæ‰§è¡Œ Â <code>vm.$nextTick</code>Â  å‡½æ•°æ¥è·å–ç»„ä»¶çš„æ¸²æŸ“å®Œæ¯•æ—¶é—´ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">&quot;setPageLoadedStartTime&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token parameter"> </span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  
  <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'setPageLoadedTime'</span><span class="token punctuation">,</span> 
  <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>pageLoadedStartTime<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="ç”¨æˆ·ä¿¡æ¯æ”¶é›†"><a href="#ç”¨æˆ·ä¿¡æ¯æ”¶é›†" class="header-anchor">#</a> ç”¨æˆ·ä¿¡æ¯æ”¶é›†</h2> <h3 id="navigator"><a href="#navigator" class="header-anchor">#</a> navigator</h3> <p>ä½¿ç”¨ window.navigator å¯ä»¥æ”¶é›†åˆ°ç”¨æˆ·çš„è®¾å¤‡ä¿¡æ¯ï¼Œæ“ä½œç³»ç»Ÿï¼Œæµè§ˆå™¨ä¿¡æ¯...</p> <h3 id="uv-unique-visitor"><a href="#uv-unique-visitor" class="header-anchor">#</a> UVï¼ˆUnique visitorï¼‰</h3> <p>æ˜¯æŒ‡é€šè¿‡äº’è”ç½‘æµè§ˆè¿™ä¸ªç½‘é¡µçš„è®¿å®¢ï¼Œ00:00-24:00 å†…ç›¸åŒçš„è®¾å¤‡è®¿é—®åªè¢«è®¡ç®—ä¸€æ¬¡ã€‚ä¸€å¤©å†…åŒä¸ªè®¿å®¢å¤šæ¬¡è®¿é—®ä»…è®¡ç®—ä¸€ä¸ª UVã€‚</p> <p>åœ¨ç”¨æˆ·è®¿é—®ç½‘ç«™æ—¶ï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸² + æ—¶é—´æ—¥æœŸï¼Œä¿å­˜åœ¨æœ¬åœ°ã€‚åœ¨ç½‘é¡µå‘ç”Ÿè¯·æ±‚æ—¶ï¼ˆå¦‚æœè¶…è¿‡å½“å¤© 24 å°æ—¶ï¼Œåˆ™é‡æ–°ç”Ÿæˆï¼‰ï¼ŒæŠŠè¿™äº›å‚æ•°ä¼ åˆ°åç«¯ï¼Œåç«¯åˆ©ç”¨è¿™äº›ä¿¡æ¯ç”Ÿæˆ UV ç»Ÿè®¡æŠ¥å‘Šã€‚</p> <h3 id="pv-page-view"><a href="#pv-page-view" class="header-anchor">#</a> PVï¼ˆPage Viewï¼‰</h3> <p>å³é¡µé¢æµè§ˆé‡æˆ–ç‚¹å‡»é‡ï¼Œç”¨æˆ·æ¯ 1 æ¬¡å¯¹ç½‘ç«™ä¸­çš„æ¯ä¸ªç½‘é¡µè®¿é—®å‡è¢«è®°å½• 1 ä¸ª PVã€‚ç”¨æˆ·å¯¹åŒä¸€é¡µé¢çš„å¤šæ¬¡è®¿é—®ï¼Œè®¿é—®é‡ç´¯è®¡ï¼Œç”¨ä»¥è¡¡é‡ç½‘ç«™ç”¨æˆ·è®¿é—®çš„ç½‘é¡µæ•°é‡ã€‚</p> <h3 id="é¡µé¢åœç•™æ—¶é—´"><a href="#é¡µé¢åœç•™æ—¶é—´" class="header-anchor">#</a> é¡µé¢åœç•™æ—¶é—´</h3> <ul><li>ä¼ ç»Ÿç½‘ç«™</li></ul> <p>ç”¨æˆ·åœ¨è¿›å…¥ A é¡µé¢æ—¶ï¼Œé€šè¿‡åå°è¯·æ±‚æŠŠç”¨æˆ·è¿›å…¥é¡µé¢çš„æ—¶é—´æä¸Šã€‚è¿‡äº† 10 åˆ†é’Ÿï¼Œç”¨æˆ·è¿›å…¥ B é¡µé¢ï¼Œè¿™æ—¶åå°å¯ä»¥é€šè¿‡æ¥å£æå¸¦çš„å‚æ•°å¯ä»¥åˆ¤æ–­å‡ºç”¨æˆ·åœ¨ A é¡µé¢åœç•™äº† 10 åˆ†é’Ÿã€‚</p> <ul><li>SPA</li></ul> <p>å¯ä»¥åˆ©ç”¨ router æ¥è·å–ç”¨æˆ·åœç•™æ—¶é—´ï¼Œæ‹¿ Vue ä¸¾ä¾‹ï¼Œé€šè¿‡ Â <code>router.beforeEach</code>ã€<code>destroyed</code>Â  è¿™ä¸¤ä¸ªé’©å­å‡½æ•°æ¥è·å–ç”¨æˆ·åœç•™è¯¥è·¯ç”±ç»„ä»¶çš„æ—¶é—´ã€‚</p> <ul><li>æµè§ˆæ·±åº¦</li></ul> <p>é€šè¿‡ Â <code>document.documentElement.scrollTop</code>Â  å±æ€§ä»¥åŠå±å¹•é«˜åº¦ï¼Œå¯ä»¥åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æµè§ˆå®Œç½‘ç«™å†…å®¹ã€‚</p> <ul><li>é¡µé¢è·³è½¬æ¥æº</li></ul> <p>é€šè¿‡ Â <code>document.referrer</code>Â  å±æ€§ï¼Œå¯ä»¥çŸ¥é“ç”¨æˆ·æ˜¯ä»å“ªä¸ªç½‘ç«™è·³è½¬è€Œæ¥ã€‚æœ‰é»˜è®¤ä¸¤ç§æƒ…å†µä¸æºå¸¦ <code>referrer</code>(<code>https</code>-&gt;è·³åˆ° <code>http</code> / ç›´æ¥æ‰“å¼€èµ„æºæ—  <code>referrer</code>)ã€‚</p> <p>è€Œæµè§ˆå™¨ä¹Ÿæ”¯æŒæ”¹å˜é»˜è®¤çš„<code>referrer</code>çš„è¡Œä¸º:</p> <p>I. å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œ<code>rel=&quot;noreferrer&quot;</code>å±æ€§æ˜¯æœ€ç®€å•çš„ä¸€ç§æ–¹æ³•ã€‚<code>&lt;a&gt;</code>ã€<code>&lt;area&gt;</code>å’Œ<code>&lt;form&gt;</code>ä¸‰ä¸ªæ ‡ç­¾å¯ä»¥ä½¿ç”¨è¿™ä¸ªå±æ€§ï¼Œä¸€æ—¦ä½¿ç”¨ï¼Œè¯¥å…ƒç´ å°±ä¸ä¼šå‘é€ <code>Referer</code> å­—æ®µã€‚</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>...<span class="token punctuation">&quot;</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>noreferrer<span class="token punctuation">&quot;</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_blank<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>xxx<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>ä¸Šé¢é“¾æ¥ç‚¹å‡»äº§ç”Ÿçš„ HTTP è¯·æ±‚ï¼Œä¸ä¼šå¸¦æœ‰ Referer å­—æ®µã€‚</p> <p>II. ä½¿ç”¨<code>Referrer Policy</code>:</p> <p>ç¬¬ä¸€ç§ä½¿ç”¨æ–¹å¼:</p> <p>åœ¨ HTTP çš„å¤´ä¿¡æ¯ä¸­æ·»åŠ <code>Referrer-Policy: origin</code></p> <p>ç¬¬äºŒç§ä½¿ç”¨æ–¹å¼:</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>referrer<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>origin<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>ç¬¬ä¸‰ç§ä½¿ç”¨æ–¹å¼:</p> <p><code>&lt;a&gt;</code>ã€<code>&lt;area&gt;</code>ã€<code>&lt;img&gt;</code>ã€<code>&lt;iframe&gt;</code>å’Œ<code>&lt;link&gt;</code>æ ‡ç­¾ï¼Œå¯ä»¥è®¾ç½® <code>referrerpolicy</code> å±æ€§ã€‚</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>...<span class="token punctuation">&quot;</span></span> <span class="token attr-name">referrerpolicy</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>origin<span class="token punctuation">&quot;</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_blank<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>xxx<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="é”™è¯¯å´©æºƒæ—¥å¿—"><a href="#é”™è¯¯å´©æºƒæ—¥å¿—" class="header-anchor">#</a> é”™è¯¯å´©æºƒæ—¥å¿—</h2> <p>ç›®å‰æ‰€èƒ½æ•æ‰çš„é”™è¯¯æœ‰ä¸‰ç§:</p> <ul><li><p>èµ„æºåŠ è½½é”™è¯¯: é€šè¿‡ Â <code>addEventListener('error', callback, true)</code>Â  åœ¨æ•è·é˜¶æ®µæ•æ‰èµ„æºåŠ è½½å¤±è´¥é”™è¯¯ã€‚</p></li> <li><p>JS æ‰§è¡Œé”™è¯¯: é€šè¿‡ Â <code>window.onerror</code>Â  æ•æ‰ JS é”™è¯¯ã€‚</p></li> <li><p>Promise é”™è¯¯: é€šè¿‡ Â <code>addEventListener('unhandledrejection', callback)</code>æ•æ‰ promise é”™è¯¯ï¼Œä½†æ˜¯æ²¡æœ‰å‘ç”Ÿé”™è¯¯çš„è¡Œæ•°ï¼Œåˆ—æ•°ç­‰ä¿¡æ¯ï¼Œåªèƒ½æ‰‹åŠ¨æŠ›å‡ºç›¸å…³é”™è¯¯ä¿¡æ¯ã€‚</p></li> <li><p>å‰ç«¯æ¡†æ¶ç±»é”™è¯¯: å‰ç«¯æ¡†æ¶å¦‚ Angule/Vue/React çš„å†…éƒ¨é”™è¯¯</p></li> <li><p>é¡µé¢å´©æºƒé”™è¯¯: åœ¨é¡µé¢å¼‚å¸¸é€€å‡ºæ—¶çš„é”™è¯¯</p></li></ul> <p>æˆ‘ä»¬å¯ä»¥å»ºä¸€ä¸ªé”™è¯¯æ•°ç»„å˜é‡ Â <code>errors</code>Â  åœ¨é”™è¯¯å‘ç”Ÿæ—¶ï¼Œå°†é”™è¯¯çš„ç›¸å…³ä¿¡æ¯æ·»åŠ åˆ°æ•°ç»„ï¼Œç„¶ååœ¨æŸä¸ªé˜¶æ®µç»Ÿä¸€ä¸ŠæŠ¥ï¼Œå…·ä½“å¦‚ä½•æ“ä½œè¯·çœ‹ä¸‹é¢çš„ä»£ç ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> monitor <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// é™æ€èµ„æºå¼‚å¸¸ç›‘å¬, éœ€åœ¨æ•è·é˜¶æ®µè·å–(è¯·æ±‚èµ„æºä¸ä¼šå†’æ³¡åˆ°window)</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span>
  <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> target <span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!==</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      monitor<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> target<span class="token punctuation">.</span>localName<span class="token punctuation">,</span>
        url<span class="token operator">:</span> target<span class="token punctuation">.</span>src <span class="token operator">||</span> target<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target<span class="token punctuation">.</span>src <span class="token operator">||</span> target<span class="token punctuation">.</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is load error</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">true</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// æ™®é€šjsé”™è¯¯</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  monitor<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;javascript&quot;</span><span class="token punctuation">,</span>
    row<span class="token punctuation">,</span>
    col<span class="token punctuation">,</span>
    msg<span class="token operator">:</span> error <span class="token operator">&amp;&amp;</span> error<span class="token punctuation">.</span>stack <span class="token operator">?</span> error<span class="token punctuation">.</span>stack <span class="token operator">:</span> msg<span class="token punctuation">,</span>
    url<span class="token punctuation">,</span>
    time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// promiseé”™è¯¯</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  monitor<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;promise&quot;</span><span class="token punctuation">,</span>
    msg<span class="token operator">:</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>reason <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>reason<span class="token punctuation">.</span>msg<span class="token punctuation">)</span> <span class="token operator">||</span> e<span class="token punctuation">.</span>reason <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è·¨åŸŸè„šæœ¬é”™è¯¯ &lt;script src=&quot;http://xxx.lorain/main.js&quot; crossorigin&gt;&lt;/script&gt;,æˆ‘ä»¬ä¸º script æ ‡ç­¾æ·»åŠ  crossOrigin å±æ€§ã€‚</span>
<span class="token comment">// æˆ–è€…åŠ¨æ€å»æ·»åŠ  js è„šæœ¬</span>
<span class="token comment">// const script = document.createElement(&quot;script&quot;);</span>
<span class="token comment">// script.crossOrigin = &quot;anonymous&quot;;</span>
<span class="token comment">// script.src = url;</span>
<span class="token comment">// document.body.appendChild(script);</span>

<span class="token comment">// æ¡†æ¶é”™è¯¯</span>
<span class="token comment">// Vueå¼‚å¸¸ç›‘å¬, 7é€šè¿‡, æ•è·vueæ¡†æ¶çš„å…¨å±€é”™è¯¯</span>
Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function-variable function">errorHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;é€šè¿‡vue errorHandleræ•è·çš„é”™è¯¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Reacté”™è¯¯ç›‘å¬, åœ¨å…¨å±€åº”ç”¨ä¸­ä½¿ç”¨é”™è¯¯ç›‘å¬ç»„ä»¶æ¥åŒ…è£¹</span>
<span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> hasError<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Display fallback UI</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> hasError<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// You can also log the error to an error reporting service</span>
    <span class="token function">logErrorToMyService</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// You can render any custom fallback UI</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Something went wrong<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// å´©æºƒç›‘å¬, ç›‘å¬é¡µé¢æ˜¯å¦æ­£å¸¸å¸è½½,ä¸€èˆ¬åœ¨service workerä¸­ç›‘å¬</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;good_exit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pending&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;time_before_crash&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;beforeunload&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;good_exit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>
  sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;good_exit&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
  sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;good_exit&quot;</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">&quot;true&quot;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* insert crash logging code here */</span>
<span class="token punctuation">}</span>

<span class="token comment">// åœ¨ä¸€èˆ¬çš„å´©æºƒå‘ç”Ÿå, ç”¨æˆ·ä¼šå¼ºæ€è„šæœ¬, å¯¼è‡´ç›‘å¬å¼‚å¸¸</span>
<span class="token comment">// åŸºäºä»¥ä¸‹åŸå› ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Service Worker æ¥å®ç°ç½‘é¡µå´©æºƒçš„ç›‘æ§ï¼š</span>
<span class="token comment">// Service Worker æœ‰è‡ªå·±ç‹¬ç«‹çš„å·¥ä½œçº¿ç¨‹ï¼Œä¸ç½‘é¡µåŒºåˆ†å¼€ï¼Œç½‘é¡µå´©æºƒäº†ï¼ŒService Worker ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šå´©æºƒï¼›</span>
<span class="token comment">// Service Worker ç”Ÿå‘½å‘¨æœŸä¸€èˆ¬è¦æ¯”ç½‘é¡µè¿˜è¦é•¿ï¼Œå¯ä»¥ç”¨æ¥ç›‘æ§ç½‘é¡µçš„çŠ¶æ€ï¼›</span>
<span class="token comment">// ç½‘é¡µå¯ä»¥é€šè¿‡ navigator.serviceWorker.controller.postMessage API å‘æŒç®¡è‡ªå·±çš„ SW å‘é€æ¶ˆæ¯ã€‚</span>

<span class="token comment">// ä»¥ä¸‹æ˜¯sdkä¸­çš„å´©æºƒç›‘å¬å¿ƒè·³ä»£ç </span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceWorker</span><span class="token punctuation">(</span><span class="token string">&quot;xxxxxx.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">CHECK_CRASH_INTERVAL</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token comment">// æ¯ 10s æ£€æŸ¥ä¸€æ¬¡</span>
<span class="token keyword">const</span> <span class="token constant">CRASH_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">15</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token comment">// 15s è¶…è¿‡15sæ²¡æœ‰å¿ƒè·³åˆ™è®¤ä¸ºå·²ç» crash</span>
<span class="token keyword">const</span> pages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> timer<span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">checkCrash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> id <span class="token keyword">in</span> pages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> page <span class="token operator">=</span> pages<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> page<span class="token punctuation">.</span>t <span class="token operator">&gt;</span> <span class="token constant">CRASH_THRESHOLD</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä¸ŠæŠ¥ crash</span>
      <span class="token keyword">delete</span> pages<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
worker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;heartbeat&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pages<span class="token punctuation">[</span>data<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> t<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">checkCrash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">CHECK_CRASH_INTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;unload&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> pages<span class="token punctuation">[</span>data<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å´©æºƒç›‘å¬ä¸­<code>service-worker</code>ä¸­çš„ä»£ç </p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token constant">HEARTBEAT_INTERVAL</span> <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token comment">// æ¯äº”ç§’å‘ä¸€æ¬¡å¿ƒè·³</span>
  <span class="token keyword">let</span> sessionId <span class="token operator">=</span> <span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token function-variable function">heartbeat</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;heartbeat&quot;</span><span class="token punctuation">,</span>
      id<span class="token operator">:</span> sessionId<span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

      <span class="token comment">// é™„åŠ ä¿¡æ¯ï¼Œå¦‚æœé¡µé¢ crashï¼Œä¸ŠæŠ¥çš„é™„åŠ æ•°æ®</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;beforeunload&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;unload&quot;</span><span class="token punctuation">,</span>
      id<span class="token operator">:</span> sessionId
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span>heartbeat<span class="token punctuation">,</span> <span class="token constant">HEARTBEAT_INTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">heartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="å…¶ä»–æ—¥å¿—"><a href="#å…¶ä»–æ—¥å¿—" class="header-anchor">#</a> å…¶ä»–æ—¥å¿—</h2> <p>è¿™å—çš„æ—¥å¿—æ ¹æ®ä¸šåŠ¡å…·ä½“æ¥å®šåˆ¶</p> <h2 id="å¦‚ä½•ä¸ŠæŠ¥"><a href="#å¦‚ä½•ä¸ŠæŠ¥" class="header-anchor">#</a> å¦‚ä½•ä¸ŠæŠ¥</h2> <p>æ”¶é›†äº†æ—¥å¿—æ•°æ®ä¹‹åé€šè¿‡æ„é€ ä¸€ä¸ªå¸¦å‚æ•° URL, å†é€šè¿‡ä¸€ä¸ª Image è¯·æ±‚å‘é€åˆ°åˆ°æœåŠ¡å™¨å°±å®Œæˆäº†æ—¥å¿—çš„ä¸ŠæŠ¥ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/r.png?page=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>location<span class="token punctuation">.</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;param=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><h2 id="ä¸ŠæŠ¥çš„æªæ–½"><a href="#ä¸ŠæŠ¥çš„æªæ–½" class="header-anchor">#</a> ä¸ŠæŠ¥çš„æªæ–½</h2> <p>åœ¨æ—¥å¿—çš„ä¸ŠæŠ¥è¿‡ç¨‹ä¸­, éœ€è¦è€ƒè™‘åˆ°çš„ä¸»è¦æ˜¯:</p> <ul><li>æ—¥å¿—ä¸ŠæŠ¥å¯é æ€§: è®¾è®¡åˆ°æµè§ˆå™¨çš„å…¼å®¹æ€§,ç½‘ç»œæœªåŠ è½½æˆåŠŸ SDK ç­‰</li> <li>æ—¥å¿—ä¸ŠæŠ¥çš„æ€§èƒ½: æ—¥å¿—æ•°æ®å¯èƒ½ä¼šéå¸¸å¤šï¼Œä¸ŠæŠ¥å¯èƒ½ä¼šå› ä¸ºæµè§ˆå™¨å¹¶å‘æ•°é‡çš„é™åˆ¶é˜»å¡ä¸šåŠ¡çš„ç½‘ç»œè¯·æ±‚ï¼Œæˆ–è€…å½±å“é¡µé¢æ€§èƒ½</li></ul> <p>ç»¼ä¸Šçš„é—®é¢˜, æ—¥å¿—ä¸ŠæŠ¥çš„æ‰‹æ®µä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§</p> <h3 id="_1-éš”ç¦»ä¸šåŠ¡ä¸ŠæŠ¥"><a href="#_1-éš”ç¦»ä¸šåŠ¡ä¸ŠæŠ¥" class="header-anchor">#</a> 1. éš”ç¦»ä¸šåŠ¡ä¸ŠæŠ¥</h3> <p>ä¸€ã€ä¸ºäº†ä¸å ç”¨ä¸šåŠ¡è®¡ç®—èµ„æºï¼Œæ—¥å¿—ä¸ŠæŠ¥éœ€è¦å•ç‹¬è®¾å®šåç«¯æœåŠ¡</p> <p>äºŒã€æµè§ˆå™¨ä¼šå¯¹åŒä¸€ä¸ªåŸŸåæœ‰ä¸€å®šçš„å¹¶å‘æ•°é™åˆ¶ï¼Œæ—¥å¿—ä¸ŠæŠ¥ä¸èƒ½ä½¿ç”¨ä¸ä¸šåŠ¡ç›¸åŒçš„åŸŸå</p> <p>ä¸‰ã€ä¸åŒåŸŸåå¯¼è‡´è·¨åŸŸ, éœ€è¦å‰åç«¯å…±åŒæ”¯æŒ</p> <blockquote><p>æœåŠ¡å™¨éœ€è¦å…è®¸å¤–éƒ¨è®¿é—® Access-Control-Allow-Origin:*ï¼›å‰ç«¯åœ¨è¿›è¡Œæ—¥å¿—ä¸ŠæŠ¥çš„æ—¶å€™è¦æ·»åŠ é¿å…è·¨åŸŸæ ‡è¯†</p></blockquote> <p>å››ã€åŸŸåä¸åŒå¸¦æ¥çš„ DNS è§£æå»¶è¿Ÿï¼Œå› æ­¤éœ€è¦ä½¿ç”¨åŸŸåé¢„è§£æ</p> <blockquote><link rel="dns-prefetch" href="https://arms-retcode.aliyuncs.com"></blockquote> <p>äº”ã€æ—¥å¿—ä¸ŠæŠ¥ä¹Ÿå¯èƒ½å‡ºç°å¼‚å¸¸, å› æ­¤ä¹Ÿéœ€è¦åŒä¸šåŠ¡åˆ†å¼€</p> <blockquote><p>æ—¥å¿—æœ¬èº«æŠ›å‡ºçš„å¼‚å¸¸ç»å¯¹ä¸èƒ½å’Œä¸šåŠ¡å¼‚å¸¸æ··åœ¨ä¸€èµ·ä¸ŠæŠ¥</p> <p>è¿›è¡Œå……åˆ†æµ‹è¯•çš„å‰æä¸‹ï¼Œæœ€ç®€å•ç²—æš´çš„æ–¹å¼æ˜¯åœ¨æ•´ä¸ªç›‘æ§ sdk å¤–é¢æ·»åŠ  try...catch..., å¥½å¤„æ˜¯æ°¸è¿œä¸ä¼šå‡ºç° sdk æœ¬èº«é”™è¯¯ä¸ŠæŠ¥ï¼Œä¸è¿‡åŒæ—¶ä¹Ÿè®©å¼€å‘è€…å¤±å»äº†å‘ç° sdk é—®é¢˜çš„é€”å¾„ã€‚æ‰€ä»¥ä¸¤è€…å…¼å¾—çš„æ–¹å¼æ˜¯å¿…è¦çš„ã€‚</p></blockquote> <h3 id="_2-å‹ç¼©è¯·æ±‚å’Œå“åº”æŠ¥æ–‡"><a href="#_2-å‹ç¼©è¯·æ±‚å’Œå“åº”æŠ¥æ–‡" class="header-anchor">#</a> 2. å‹ç¼©è¯·æ±‚å’Œå“åº”æŠ¥æ–‡</h3> <p>åœ¨ä¸Šé¢æåˆ°ä½¿ç”¨å›¾ç‰‡åŠ URL å‚æ•°æ¥ä¸ŠæŠ¥æ—¥å¿—, å…¶å®è¿™ä¸ªæ–¹æ¡ˆä¹Ÿæœ‰ä»–çš„ç¼ºé™·:</p> <h4 id="é•¿åº¦é™åˆ¶-æ—¥å¿—ä¸ŠæŠ¥é€šè¿‡-url-å‚æ•°ä¼ é€’-url-é•¿åº¦æ˜¯æœ‰é™åˆ¶çš„"><a href="#é•¿åº¦é™åˆ¶-æ—¥å¿—ä¸ŠæŠ¥é€šè¿‡-url-å‚æ•°ä¼ é€’-url-é•¿åº¦æ˜¯æœ‰é™åˆ¶çš„" class="header-anchor">#</a> é•¿åº¦é™åˆ¶: æ—¥å¿—ä¸ŠæŠ¥é€šè¿‡ URL å‚æ•°ä¼ é€’,URL é•¿åº¦æ˜¯æœ‰é™åˆ¶çš„</h4> <p>å› æ­¤, å¯ä»¥é‡‡ç”¨ HTTP2 çš„å¤´éƒ¨å‹ç¼©, <code>JS Error</code>é”™è¯¯æ ˆä¿¡æ¯åº”è¯¥ä½¿ç”¨å­—ç¬¦ä¸²æ¥ä¿å­˜ç›¸åŒéƒ¨åˆ†, å‹ç¼©ç©ºé—´å°±æ¥æºäº stack ä¸­ js æ–‡ä»¶çš„ url é‡å¤ã€‚</p> <p>ä¸€ä¸ªå…¸å‹çš„ jserror stack ç»å¸¸ä¼šå‡ºç°è¿™ç§å½¢å¼å¦‚ä¸‹ï¼š</p> <div class="language-error extra-class"><pre class="language-text"><code>obj0.fn0 at (&lt;http://loooooooooonnnnnnnnnnng/loooooong/long.js&gt; 123:1)

obj1.fn1 at (&lt;http://loooooooooonnnnnnnnnnng/loooooong/long.js&gt; 234:1)

obj2.fn2 at (&lt;http://loooooooooonnnnnnnnnnng/laaaaaang/lang.js&gt; 345:1)

</code></pre></div><p>å¯è€ƒè™‘æŠŠæ–‡ä»¶ url æŠ½å–å‡ºæ¥å•ç‹¬ä½œä¸ºä¸€ä¸ªå­—å…¸ï¼Œé‚£ä¹ˆä¸ŠæŠ¥å†…å®¹å¯ç¼©å‡ä¸º</p> <div class="language-error extra-class"><pre class="language-text"><code>files={'f1':'http://loooooooooonnnnnnnnnnng/loooooong/long.js','f2':'...'}

obj0.fn0 at (f1 123:1)

obj1.fn1 at (f1 234:1)

obj2.fn2 at (f2 345:1)

</code></pre></div><h4 id="ä¸ŠæŠ¥å“åº”-åªéœ€å…³æ³¨æ—¥å¿—æœ‰æ²¡æœ‰ä¸ŠæŠ¥-è€Œå¯¹ä¸ŠæŠ¥è¯·æ±‚çš„è¿”å›å†…å®¹å¹¶ä¸å…³æ³¨"><a href="#ä¸ŠæŠ¥å“åº”-åªéœ€å…³æ³¨æ—¥å¿—æœ‰æ²¡æœ‰ä¸ŠæŠ¥-è€Œå¯¹ä¸ŠæŠ¥è¯·æ±‚çš„è¿”å›å†…å®¹å¹¶ä¸å…³æ³¨" class="header-anchor">#</a> ä¸ŠæŠ¥å“åº”: åªéœ€å…³æ³¨æ—¥å¿—æœ‰æ²¡æœ‰ä¸ŠæŠ¥ï¼Œè€Œå¯¹ä¸ŠæŠ¥è¯·æ±‚çš„è¿”å›å†…å®¹å¹¶ä¸å…³æ³¨</h4> <p>æ—¥å¿—ä¸ŠæŠ¥æœ¬èº«åªå…³æ³¨æ—¥å¿—æœ‰æ²¡æœ‰ä¸ŠæŠ¥ï¼Œè€Œå¯¹ä¸ŠæŠ¥è¯·æ±‚çš„è¿”å›å†…å®¹å¹¶ä¸å…³æ³¨ï¼Œç”šè‡³å®Œå…¨å¯ä»¥ä¸éœ€è¦è¿”å›å†…å®¹ã€‚æ‰€ä»¥ä½¿ç”¨ HTTP HEAD çš„æ–¹å¼ä¸ŠæŠ¥ï¼Œå¹¶ä¸”è¿”å›çš„å“åº”ä½“ä¸ºç©ºï¼Œé¿å…å“åº”ä½“ä¼ è¾“èµ„æºæŸè€—ã€‚</p> <p>è¿™æ—¶å€™åªéœ€è¦è®¾ç½®ä¸€ä¸ª nginx æœåŠ¡å™¨æ¥è®°å½•æ—¥å¿—å†…å®¹å¹¶è¿”å› 200 çŠ¶æ€ç å³å¯ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?t=perf&amp;page=lazada-home&amp;load=1168</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">&quot;no-cors&quot;</span><span class="token punctuation">,</span>
  method<span class="token operator">:</span> <span class="token string">&quot;HEAD&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-åˆå¹¶ä¸ŠæŠ¥"><a href="#_3-åˆå¹¶ä¸ŠæŠ¥" class="header-anchor">#</a> 3. åˆå¹¶ä¸ŠæŠ¥</h3> <p>é¡µé¢ä¸ŠæŠ¥çš„æ¬¡æ•°é‚£ä¹ˆå¤šï¼Œæˆ‘ä»¬åº”è¯¥æ˜¯æŠŠæ—¥å¿—åˆå¹¶ä¸ŠæŠ¥æ¥å‡å°è¯·æ±‚æ•°é‡</p> <h4 id="å¼€å¯-http2-ä½¿ç”¨-http-2-çš„å¤šè·¯å¤ç”¨æ¥åˆå¹¶ä¸ŠæŠ¥"><a href="#å¼€å¯-http2-ä½¿ç”¨-http-2-çš„å¤šè·¯å¤ç”¨æ¥åˆå¹¶ä¸ŠæŠ¥" class="header-anchor">#</a> å¼€å¯ Http2, ä½¿ç”¨ HTTP/2 çš„å¤šè·¯å¤ç”¨æ¥åˆå¹¶ä¸ŠæŠ¥</h4> <p>ç”¨æˆ·æµè§ˆå™¨å’Œæ—¥å¿—æœåŠ¡å™¨ä¹‹é—´äº§ç”Ÿå¤šæ¬¡ HTTP è¯·æ±‚,è€Œåœ¨ HTTP/1.1 Keep-Alive ä¸‹ï¼Œæ—¥å¿—ä¸ŠæŠ¥ä¼šä»¥ä¸²è¡Œçš„æ–¹å¼ä¼ è¾“ï¼Œä¼šè®©åé¢çš„æ—¥å¿—ä¸ŠæŠ¥å»¶æ—¶ã€‚é€šè¿‡ HTTP/2 çš„å¤šè·¯å¤ç”¨æ¥åˆå¹¶ä¸ŠæŠ¥ï¼ŒèŠ‚çœç½‘ç»œè¿æ¥çš„å¼€é”€ã€‚</p> <h4 id="http-post-åˆå¹¶"><a href="#http-post-åˆå¹¶" class="header-anchor">#</a> HTTP POST åˆå¹¶</h4> <p>åœ¨ HTTP POST ä¸­åªè¦ä¸€æ¬¡åŒ…å«å¤šæ¡æ—¥å¿—çš„å†…å®¹ï¼Œé‚£ä¹ˆç›¸å¯¹äºä¸€æ¡æ—¥å¿—ä¸€æ¬¡ HTTP HEAD è¯·æ±‚çš„æ–¹å¼ä¼šæ›´åŠ ç»æµ; å…¶æ¬¡éœ€è¦è§£å†³ç”¨æˆ·å…³æ‰æˆ–è€…åˆ‡æ¢é¡µé¢é€ æˆçš„æ¼æŠ¥é—®é¢˜</p> <p>å¸¸è§çš„æ–¹æ¡ˆä¸»è¦æ˜¯<code>unload</code>æˆ–è€…<code>beforeUnload</code>äº‹ä»¶ä¸­è¿›è¡Œä¸ŠæŠ¥, ä¸ŠæŠ¥å¯ä»¥ä½¿ç”¨åŒæ­¥ä¸ŠæŠ¥æˆ–è€…<code>navigation.setBeacon</code>è¿›è¡Œå¼‚æ­¥ä¸ŠæŠ¥</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// åŒæ­¥ä¸ŠæŠ¥</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unload&quot;</span><span class="token punctuation">,</span> uploadLog<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">uploadLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/xx.png&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// falseè¡¨ç¤ºåŒæ­¥</span>

  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>logData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// å¼‚æ­¥ä¸ŠæŠ¥</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unload&quot;</span><span class="token punctuation">,</span> uploadLog<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">uploadLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span><span class="token string">&quot;/xx.png&quot;</span><span class="token punctuation">,</span> logData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åˆå¹¶å‰:</p> <p><img src="/blog/skills/images/log-upload-sync.webp" alt="åˆå¹¶å‰"></p> <p>åˆå¹¶å:</p> <p><img src="/blog/skills/images/log-upload-async.webp" alt="åˆå¹¶å"></p> <h2 id="å‚è€ƒå†…å®¹"><a href="#å‚è€ƒå†…å®¹" class="header-anchor">#</a> å‚è€ƒå†…å®¹</h2> <ul><li><a href="https://blog.fundebug.com/2019/07/12/frontend-monitor-http-error/#1-%E5%A6%82%E4%BD%95%E7%9B%91%E5%90%ACajax%E8%AF%B7%E6%B1%82" target="_blank" rel="noopener noreferrer">ä¸€æ­¥ä¸€æ­¥æ­å»ºå‰ç«¯ç›‘æ§ç³»ç»Ÿ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">æ›´æ–°æ—¶é—´:</span> <span class="time">4/4/2021, 2:31:03 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/blog/skills/æ€§èƒ½ä¼˜åŒ–æ€»ç»“.html" class="prev">
        æ€§èƒ½ä¼˜åŒ–æ€»ç»“
      </a></span> <span class="next"><a href="/blog/skills/æœåŠ¡å™¨æ¨é€.html">
        æœåŠ¡å™¨æ¨é€
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.021feda6.js" defer></script><script src="/blog/assets/js/3.8c44ca0e.js" defer></script><script src="/blog/assets/js/42.12103f07.js" defer></script><script src="/blog/assets/js/4.57980df9.js" defer></script>
  </body>
</html>

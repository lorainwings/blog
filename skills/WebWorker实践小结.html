<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WebWorker 实践小结 | Lorain&#39;s 个人主页🖌</title>
    <meta name="generator" content="VuePress 1.8.1">
    <link rel="icon" href="/blog/base/hd-img.jpg">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/base/hd-img.jpg">
    <meta name="description" content="山中樗栎年年在 & 看尽西风木槿花">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta http-quiv="pragma" cotent="no-cache">
    <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
    <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/blog/assets/css/0.styles.68529e48.css" as="style"><link rel="preload" href="/blog/assets/js/app.fca59600.js" as="script"><link rel="preload" href="/blog/assets/js/3.8a6bfa10.js" as="script"><link rel="preload" href="/blog/assets/js/31.9490002b.js" as="script"><link rel="preload" href="/blog/assets/js/4.3c831ab3.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.40f921fc.js"><link rel="prefetch" href="/blog/assets/js/11.b1a5db24.js"><link rel="prefetch" href="/blog/assets/js/12.32eadbcb.js"><link rel="prefetch" href="/blog/assets/js/13.605aab50.js"><link rel="prefetch" href="/blog/assets/js/14.e621e259.js"><link rel="prefetch" href="/blog/assets/js/15.a17f293c.js"><link rel="prefetch" href="/blog/assets/js/16.4cf8e286.js"><link rel="prefetch" href="/blog/assets/js/17.0187e264.js"><link rel="prefetch" href="/blog/assets/js/18.a9a7f87d.js"><link rel="prefetch" href="/blog/assets/js/19.39221c93.js"><link rel="prefetch" href="/blog/assets/js/20.763a09e2.js"><link rel="prefetch" href="/blog/assets/js/21.abd84741.js"><link rel="prefetch" href="/blog/assets/js/22.621fc027.js"><link rel="prefetch" href="/blog/assets/js/23.f5fdb6b0.js"><link rel="prefetch" href="/blog/assets/js/24.d179bd37.js"><link rel="prefetch" href="/blog/assets/js/25.79c3d42c.js"><link rel="prefetch" href="/blog/assets/js/26.7e5fb699.js"><link rel="prefetch" href="/blog/assets/js/27.6d2e2ca2.js"><link rel="prefetch" href="/blog/assets/js/28.711f2fab.js"><link rel="prefetch" href="/blog/assets/js/29.b7f987c3.js"><link rel="prefetch" href="/blog/assets/js/30.0a3630f2.js"><link rel="prefetch" href="/blog/assets/js/32.0b088754.js"><link rel="prefetch" href="/blog/assets/js/33.46448628.js"><link rel="prefetch" href="/blog/assets/js/34.9212905b.js"><link rel="prefetch" href="/blog/assets/js/35.5013d6d2.js"><link rel="prefetch" href="/blog/assets/js/36.531ff59f.js"><link rel="prefetch" href="/blog/assets/js/37.52f1002a.js"><link rel="prefetch" href="/blog/assets/js/38.3a2afa1a.js"><link rel="prefetch" href="/blog/assets/js/39.e65253d3.js"><link rel="prefetch" href="/blog/assets/js/40.92a22c61.js"><link rel="prefetch" href="/blog/assets/js/41.01c2e535.js"><link rel="prefetch" href="/blog/assets/js/42.fca6ea9d.js"><link rel="prefetch" href="/blog/assets/js/43.6e4dac46.js"><link rel="prefetch" href="/blog/assets/js/44.048fab3d.js"><link rel="prefetch" href="/blog/assets/js/45.60a1d461.js"><link rel="prefetch" href="/blog/assets/js/5.8a039903.js"><link rel="prefetch" href="/blog/assets/js/6.29bb3ac6.js"><link rel="prefetch" href="/blog/assets/js/7.ae762a13.js"><link rel="prefetch" href="/blog/assets/js/8.2597e5ec.js"><link rel="prefetch" href="/blog/assets/js/9.f2677d57.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.62a8c583.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.68529e48.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Lorain's 个人主页🖌</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/skills/" class="nav-link router-link-active">
  📜前端技术
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  📊计算机基础
</a></div><div class="nav-item"><a href="/blog/life/" class="nav-link">
  🍀其他记录
</a></div><div class="nav-item"><a href="https://github.com/lorainwings" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ⭐️Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/skills/" class="nav-link router-link-active">
  📜前端技术
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  📊计算机基础
</a></div><div class="nav-item"><a href="/blog/life/" class="nav-link">
  🍀其他记录
</a></div><div class="nav-item"><a href="https://github.com/lorainwings" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ⭐️Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS语言基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>H5及框架</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/Base64.html" class="sidebar-link">Base64</a></li><li><a href="/blog/skills/图片分类.html" class="sidebar-link">图片分类</a></li><li><a href="/blog/skills/Rxjs初探.html" class="sidebar-link">Rxjs 初探</a></li><li><a href="/blog/skills/H5定位API.html" class="sidebar-link">H5 定位 API</a></li><li><a href="/blog/skills/初识Typescript.html" class="sidebar-link">初识 Typescript</a></li><li><a href="/blog/skills/Git 常用技巧.html" class="sidebar-link">Git 常用技巧</a></li><li><a href="/blog/skills/WebWorker实践小结.html" class="active sidebar-link">WebWorker 实践小结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/skills/WebWorker实践小结.html#代码实现" class="sidebar-link">代码实现</a></li><li class="sidebar-sub-header"><a href="/blog/skills/WebWorker实践小结.html#构建配置" class="sidebar-link">构建配置</a></li><li class="sidebar-sub-header"><a href="/blog/skills/WebWorker实践小结.html#在-stackoverflow-中的参考" class="sidebar-link">在 StackOverflow 中的参考</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>安全及性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>服务端入门</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="webworker-实践小结"><a href="#webworker-实践小结" class="header-anchor">#</a> WebWorker 实践小结</h1> <p>WebWork 允许浏览器开辟一条独立的线程且不影响主线程的运行, 一般用于处理浏览器的密集型计算。本文主要探讨如何在实际的项目中运用它, 具体的介绍可以参考阮大的文章<a href="http://www.ruanyifeng.com/blog/2018/07/web-worker.html" target="_blank" rel="noopener noreferrer">Web Worker 使用教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>文章结构主要分以下两部分</p> <ul><li>代码实现</li> <li>构建配置</li></ul> <h2 id="代码实现"><a href="#代码实现" class="header-anchor">#</a> 代码实现</h2> <ul><li>主线程代码[<strong>main.js</strong>]</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// relative path to the worker from current file</span>
<span class="token keyword">import</span> Worker <span class="token keyword">from</span> <span class="token string">&quot;../../utils/sleep.worker&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> wk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
wk<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;data:application/json;base64,asfasdfs&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
wk<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">d</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;主线程收到消息!&quot;</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>WebWorker 线程代码[<strong>worker 线程代码</strong>]</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// use import like you would in any other file</span>
<span class="token keyword">import</span> moment <span class="token keyword">from</span> <span class="token string">&quot;moment&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">countNum</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">,</span>
    date<span class="token operator">:</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY-MM-DD: hh:mm:ss&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;worker线程收到消息&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">countNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="构建配置"><a href="#构建配置" class="header-anchor">#</a> 构建配置</h2> <p>要让 WebWorker 使用外部依赖, 可以使用 Webpack 来加载第三方包, 也可以直接使用原生的<code>importScript</code>来引入第三方包</p> <h3 id="配置-webpack"><a href="#配置-webpack" class="header-anchor">#</a> 配置 Webpack</h3> <p>此处以<code>Webpack</code>为例子, 可以通过以下两种方式来使用<code>Webworker</code></p> <ul><li>配置 worker 模块 到 entry</li> <li>通过 worker-loader 加载</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.config.js entry</span>
modules<span class="token punctuation">.</span>exports<span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token punctuation">{</span>
  main<span class="token operator">:</span> <span class="token string">'./src/app/main.js'</span>
  worker<span class="token operator">:</span> <span class="token string">'./src/utils/myWorker.js'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">ROOT_PATH</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/public</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  filename<span class="token operator">:</span> <span class="token string">'[name].bundle.js'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果需要使用 loader 方式, 必须先安装相应的<code>worker-loader</code>, 具体的 loader 相关介绍, 请移步至: <a href="https://webpack.js.org/loaders/worker-loader/" target="_blank" rel="noopener noreferrer">Webpack worker-loader documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> worker-loader --save-dev
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//With Webpack (worker-loader)</span>
<span class="token comment">//webpack.config.js</span>
modules<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.worker\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">{</span> loader<span class="token operator">:</span> <span class="token string">&quot;worker-loader&quot;</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="直接使用-importscript-来加载外部包"><a href="#直接使用-importscript-来加载外部包" class="header-anchor">#</a> 直接使用 importScript 来加载外部包</h3> <p>You can always import the library from a CDN</p> <div class="language-js extra-class"><pre class="language-js"><code>myWorker<span class="token punctuation">.</span>js<span class="token punctuation">;</span>
<span class="token function">importScripts</span><span class="token punctuation">(</span>
  <span class="token string">&quot;//cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js&quot;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">From worker: worker started at </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="在-stackoverflow-中的参考"><a href="#在-stackoverflow-中的参考" class="header-anchor">#</a> 在 StackOverflow 中的参考</h2> <p>Other bundlers
Web workers cannot importScripts from parent folders for security reasons
The node_modules folder is usually at the root of the project so you can't access it with importScripts
The bundler needs to be configured so that the content can be aliased or copied to a location the worker can access</p> <h3 id="angularcli-and-ionic-使用"><a href="#angularcli-and-ionic-使用" class="header-anchor">#</a> AngularCLI and Ionic 使用</h3> <p>For projects using webpack as a bundler the 2 webpack solutions can be adapted as long as you can access the webpack config and customize it.</p> <p>The &quot;Webpack (as entry)&quot; example was actually borrowed from Angular CLI generated app with Web Workers</p> <p>It explains how to modify the setup to bootstrap angular using web workers
It have been referenced as a webworker solution for Ionic projects too</p> <p>Note on TypeScript
you may need a separate ts config in the worker folder
Structuring a TypeScript project with workers</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">extends</span><span class="token operator">:</span> <span class="token string">&quot;../generic-tsconfig.json&quot;</span><span class="token punctuation">,</span>
  compilerOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
    lib<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;esnext&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;webworker&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2/8/2021, 10:37:49 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/skills/Git 常用技巧.html" class="prev">
        Git 常用技巧
      </a></span> <span class="next"><a href="/blog/skills/Babel杂谈.html">
        Babel 杂谈
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.fca59600.js" defer></script><script src="/blog/assets/js/3.8a6bfa10.js" defer></script><script src="/blog/assets/js/31.9490002b.js" defer></script><script src="/blog/assets/js/4.3c831ab3.js" defer></script>
  </body>
</html>

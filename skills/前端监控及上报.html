<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端监控及上报 | Lorain&#39;s Diary</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/blog/base/hd-img.jpg">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/base/hd-img.jpg">
    <meta name="description" content="山中樗栎年年在 & 看尽西风木槿花">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta http-quiv="pragma" cotent="no-cache">
    <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
    <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/blog/assets/css/0.styles.4a9580f2.css" as="style"><link rel="preload" href="/blog/assets/js/app.20bea726.js" as="script"><link rel="preload" href="/blog/assets/js/3.8c44ca0e.js" as="script"><link rel="preload" href="/blog/assets/js/42.65bd37b4.js" as="script"><link rel="preload" href="/blog/assets/js/4.57980df9.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.930d1339.js"><link rel="prefetch" href="/blog/assets/js/11.cdeb8098.js"><link rel="prefetch" href="/blog/assets/js/12.c8cde42b.js"><link rel="prefetch" href="/blog/assets/js/13.a227fbb7.js"><link rel="prefetch" href="/blog/assets/js/14.6af4650a.js"><link rel="prefetch" href="/blog/assets/js/15.6eaa9661.js"><link rel="prefetch" href="/blog/assets/js/16.061f9c22.js"><link rel="prefetch" href="/blog/assets/js/17.45db52d8.js"><link rel="prefetch" href="/blog/assets/js/18.5f9597d2.js"><link rel="prefetch" href="/blog/assets/js/19.b4ea0dfc.js"><link rel="prefetch" href="/blog/assets/js/20.7f19d52d.js"><link rel="prefetch" href="/blog/assets/js/21.d8589558.js"><link rel="prefetch" href="/blog/assets/js/22.f566dc38.js"><link rel="prefetch" href="/blog/assets/js/23.b69d67c8.js"><link rel="prefetch" href="/blog/assets/js/24.643b50bd.js"><link rel="prefetch" href="/blog/assets/js/25.31cd7e03.js"><link rel="prefetch" href="/blog/assets/js/26.e8823c82.js"><link rel="prefetch" href="/blog/assets/js/27.a7430202.js"><link rel="prefetch" href="/blog/assets/js/28.d8ebaaa5.js"><link rel="prefetch" href="/blog/assets/js/29.4c8e906e.js"><link rel="prefetch" href="/blog/assets/js/30.ae43da30.js"><link rel="prefetch" href="/blog/assets/js/31.75349241.js"><link rel="prefetch" href="/blog/assets/js/32.9b6fe64e.js"><link rel="prefetch" href="/blog/assets/js/33.4259a063.js"><link rel="prefetch" href="/blog/assets/js/34.4e487b39.js"><link rel="prefetch" href="/blog/assets/js/35.5844e768.js"><link rel="prefetch" href="/blog/assets/js/36.cd999bec.js"><link rel="prefetch" href="/blog/assets/js/37.3d9a9f24.js"><link rel="prefetch" href="/blog/assets/js/38.e4fa97e3.js"><link rel="prefetch" href="/blog/assets/js/39.8ba92439.js"><link rel="prefetch" href="/blog/assets/js/40.3e0a8f49.js"><link rel="prefetch" href="/blog/assets/js/41.55113ca5.js"><link rel="prefetch" href="/blog/assets/js/43.94613343.js"><link rel="prefetch" href="/blog/assets/js/44.ec233cc6.js"><link rel="prefetch" href="/blog/assets/js/45.555be71a.js"><link rel="prefetch" href="/blog/assets/js/46.03a26959.js"><link rel="prefetch" href="/blog/assets/js/47.b29d5306.js"><link rel="prefetch" href="/blog/assets/js/48.cd893ec3.js"><link rel="prefetch" href="/blog/assets/js/49.12210cfc.js"><link rel="prefetch" href="/blog/assets/js/5.5d055cab.js"><link rel="prefetch" href="/blog/assets/js/50.ddcb3929.js"><link rel="prefetch" href="/blog/assets/js/51.ec0a7d07.js"><link rel="prefetch" href="/blog/assets/js/52.73a630cf.js"><link rel="prefetch" href="/blog/assets/js/53.989d0b51.js"><link rel="prefetch" href="/blog/assets/js/6.5cf5829a.js"><link rel="prefetch" href="/blog/assets/js/7.46c43574.js"><link rel="prefetch" href="/blog/assets/js/8.97b71141.js"><link rel="prefetch" href="/blog/assets/js/9.5a3cc726.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.8f04fa7f.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.4a9580f2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Lorain's Diary</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/skills/" class="nav-link router-link-active">
  📜前端技术
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  📊计算机基础
</a></div><div class="nav-item"><a href="/blog/life/" class="nav-link">
  🍀其他记录
</a></div><div class="nav-item"><a href="https://github.com/lorainwings" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ⭐️Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/skills/" class="nav-link router-link-active">
  📜前端技术
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  📊计算机基础
</a></div><div class="nav-item"><a href="/blog/life/" class="nav-link">
  🍀其他记录
</a></div><div class="nav-item"><a href="https://github.com/lorainwings" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ⭐️Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS语言基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>H5及框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>安全及性能优化</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/skills/浏览器缓存.html" class="sidebar-link">浏览器缓存</a></li><li><a href="/blog/skills/前端安全防范.html" class="sidebar-link">前端安全防范</a></li><li><a href="/blog/skills/Web性能优化.html" class="sidebar-link">Web 性能优化</a></li><li><a href="/blog/skills/性能优化总结.html" class="sidebar-link">性能优化总结</a></li><li><a href="/blog/skills/前端监控及上报.html" class="active sidebar-link">前端监控及上报</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/skills/前端监控及上报.html#国内监控平台" class="sidebar-link">国内监控平台</a></li><li class="sidebar-sub-header"><a href="/blog/skills/前端监控及上报.html#常见的日志分类" class="sidebar-link">常见的日志分类</a></li><li class="sidebar-sub-header"><a href="/blog/skills/前端监控及上报.html#网络通信日志" class="sidebar-link">网络通信日志</a></li><li class="sidebar-sub-header"><a href="/blog/skills/前端监控及上报.html#性能数据采集" class="sidebar-link">性能数据采集</a></li><li class="sidebar-sub-header"><a href="/blog/skills/前端监控及上报.html#用户行为日志" class="sidebar-link">用户行为日志</a></li><li class="sidebar-sub-header"><a href="/blog/skills/前端监控及上报.html#错误崩溃日志" class="sidebar-link">错误崩溃日志</a></li><li class="sidebar-sub-header"><a href="/blog/skills/前端监控及上报.html#其他日志" class="sidebar-link">其他日志</a></li><li class="sidebar-sub-header"><a href="/blog/skills/前端监控及上报.html#如何上报" class="sidebar-link">如何上报</a></li><li class="sidebar-sub-header"><a href="/blog/skills/前端监控及上报.html#上报的措施" class="sidebar-link">上报的措施</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>服务端入门</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="前端监控及上报"><a href="#前端监控及上报" class="header-anchor">#</a> 前端监控及上报</h1> <p>前端业务越来越复杂的今天，即便本地做各种各样充分的测试，依照 caniuse 把兼容性也一一处理，依然保证页面完全正常运行, 同时我们也不清楚运行的状况。
前端的页面跟设备、浏览器、网络环境、用户操作习惯等等各种各样的因素密切相关。因此前端监控并上报日志到日志服务器是保证快速收集和处理问题的必要手段。</p> <ul><li><p>页面在用户那里运行，如果 10%的用户页面出现问题而自己本地没有办法重现？</p></li> <li><p>如何先一步了解到前端出现的问题，而不是等用户反馈？</p></li> <li><p>能不能像查看服务端日志一样来定位前端页面运行的问题？</p></li></ul> <h2 id="国内监控平台"><a href="#国内监控平台" class="header-anchor">#</a> 国内监控平台</h2> <p>国内常用的监控平台下面几个还不错, 主要缺点就是价格了...</p> <ul><li><code>sentry</code> ：从监控错误、错误统计图表、多重标签过滤和标签统计到触发告警，这一整套都很完善，团队项目需要充钱，而且数据量越大钱越贵</li> <li><code>fundebug</code>：除了监控错误，还可以录屏，也就是记录错误发生的前几秒用户的所有操作，压缩后的体积只有几十 KB，但操作略微繁琐</li> <li><code>webfunny</code>：也是含有监控错误的功能，可以支持千万级别日 PV 量，额外的亮点是可以远程调试、性能分析，也可以 docker 私有化部署（免费），业务代码加密过</li></ul> <h2 id="常见的日志分类"><a href="#常见的日志分类" class="header-anchor">#</a> 常见的日志分类</h2> <ul><li>页面及 API 请求和响应状态(成功与否)及响应时长</li> <li>页面性能日志(页面连接耗时、首次渲染时间、资源加载耗时等)</li> <li>页面行为日志(PV/UV 等等)</li> <li>页面错误日志(JS 执行情况/JS 错误情况/网页崩溃)</li> <li>页面业务日志</li> <li>页面自定义日志</li></ul> <h2 id="网络通信日志"><a href="#网络通信日志" class="header-anchor">#</a> 网络通信日志</h2> <h2 id="性能数据采集"><a href="#性能数据采集" class="header-anchor">#</a> 性能数据采集</h2> <div class="custom-block tip"><p class="custom-block-title">Performance</p> <p>Performance 接口可以获取到当前页面中与性能相关的信息，它是 High Resolution Time API 的一部分，同时也融合了 Performance Timeline API、Navigation Timing API、 User Timing API 和 Resource Timing API。</p></div> <p>其中采集性能数据, 用到的 API 是<code>window.performance.timing</code>, 这里用两张图来展示对应关系吧</p> <p><img src="/blog/skills/images/performance-api.webp" alt="performance-api.webp"> <img src="/blog/skills/images/performance-level.webp" alt="performance-level.webp"></p> <p>为了方便展示, 我这里再用一个对象来展示:</p> <div class="language-js extra-class"><pre class="language-js"><code>timing<span class="token operator">:</span> <span class="token punctuation">{</span>
 navigationStart<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

 unloadEventStart<span class="token operator">:</span> <span class="token number">1543806782523</span><span class="token punctuation">,</span>

 unloadEventEnd<span class="token operator">:</span> <span class="token number">1543806782523</span><span class="token punctuation">,</span>

 redirectStart<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>

 redirectEnd<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>

 fetchStart<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

 domainLookupStart<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

 domainLookupEnd<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

 connectStart<span class="token operator">:</span> <span class="token number">1543806782099</span><span class="token punctuation">,</span>

 connectEnd<span class="token operator">:</span> <span class="token number">1543806782227</span><span class="token punctuation">,</span>

 secureConnectionStart<span class="token operator">:</span> <span class="token number">1543806782162</span><span class="token punctuation">,</span>

 requestStart<span class="token operator">:</span> <span class="token number">1543806782241</span><span class="token punctuation">,</span>

 responseStart<span class="token operator">:</span> <span class="token number">1543806782516</span><span class="token punctuation">,</span>

 responseEnd<span class="token operator">:</span> <span class="token number">1543806782537</span><span class="token punctuation">,</span>

 domLoading<span class="token operator">:</span> <span class="token number">1543806782573</span><span class="token punctuation">,</span>

 domInteractive<span class="token operator">:</span> <span class="token number">1543806783203</span><span class="token punctuation">,</span>

 domContentLoadedEventStart<span class="token operator">:</span> <span class="token number">1543806783203</span><span class="token punctuation">,</span>

 domContentLoadedEventEnd<span class="token operator">:</span> <span class="token number">1543806783216</span><span class="token punctuation">,</span>

 domComplete<span class="token operator">:</span> <span class="token number">1543806783796</span><span class="token punctuation">,</span>

 loadEventStart<span class="token operator">:</span> <span class="token number">1543806783796</span><span class="token punctuation">,</span>

 loadEventEnd<span class="token operator">:</span> <span class="token number">1543806783802</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们常用到的计算公式:</p> <div class="language-docs extra-class"><pre class="language-text"><code>redirect: timing.redirectEnd - timing.redirectStart,

dom: timing.domComplete - timing.domLoading,

load: timing.loadEventEnd - timing.navigationStart,

unload: timing.unloadEventEnd - timing.unloadEventStart,

request: timing.responseEnd - timing.requestStart,

time: new Date().getTime(),
</code></pre></div><h3 id="白屏时间计算"><a href="#白屏时间计算" class="header-anchor">#</a> 白屏时间计算</h3> <p>还有一个比较重要的时间就是白屏时间，它指从输入网址，到页面开始显示内容的时间。</p> <p>将以下脚本放在 <code>&lt;/head&gt;</code>前面就能获取白屏时间。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  whiteScreen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>navigationStart<span class="token punctuation">;</span>
  whiteScreen <span class="token operator">=</span>
    performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>domLoading <span class="token operator">-</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>navigationStart<span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="资源加载时间计算"><a href="#资源加载时间计算" class="header-anchor">#</a> 资源加载时间计算</h3> <p>通过  <code>window.performance.getEntriesByType('resource')</code>  这个方法，我们还可以获取相关资源（js、css、img...）的加载时间，它会返回页面当前所加载的所有资源。</p> <p><img src="/blog/skills/images/performance-resource.webp" alt="performance-resource"></p> <p>它一般包括以下几个类型：</p> <ul><li>sciprt</li> <li>link</li> <li>img</li> <li>css</li> <li>fetch</li> <li>other</li> <li>xmlhttprequest</li></ul> <p>我们只需用到以下几个信息：</p> <div class="language-docs extra-class"><pre class="language-text"><code>name: item.name,duration: item.duration.toFixed(2),size: item.transferSize,protocol: item.nextHopProtocol,
</code></pre></div><p>现在，写几行代码来收集这些数据。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">getPerformance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>performance<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> timing <span class="token punctuation">}</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">;</span>
  <span class="token keyword">const</span> performance <span class="token operator">=</span> <span class="token punctuation">{</span>
    redirect<span class="token operator">:</span> timing<span class="token punctuation">.</span>redirectEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>redirectStart<span class="token punctuation">,</span>
    whiteScreen<span class="token punctuation">,</span>
    dom<span class="token operator">:</span> timing<span class="token punctuation">.</span>domComplete <span class="token operator">-</span> timing<span class="token punctuation">.</span>domLoading<span class="token punctuation">,</span>
    load<span class="token operator">:</span> timing<span class="token punctuation">.</span>loadEventEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>navigationStart<span class="token punctuation">,</span>
    unload<span class="token operator">:</span> timing<span class="token punctuation">.</span>unloadEventEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>unloadEventStart<span class="token punctuation">,</span>
    request<span class="token operator">:</span> timing<span class="token punctuation">.</span>responseEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>requestStart<span class="token punctuation">,</span>
    time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> performance<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">getResources</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>performance<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span><span class="token function">getEntriesByType</span><span class="token punctuation">(</span><span class="token string">&quot;resource&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> resource <span class="token operator">=</span> <span class="token punctuation">{</span>
    xmlhttprequest<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    css<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    other<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    script<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    img<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    link<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    fetch<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> arry <span class="token operator">=</span> resource<span class="token punctuation">[</span>item<span class="token punctuation">.</span>initiatorType<span class="token punctuation">]</span><span class="token punctuation">;</span>
    arry <span class="token operator">&amp;&amp;</span>
      arry<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        name<span class="token operator">:</span> item<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        duration<span class="token operator">:</span> item<span class="token punctuation">.</span>duration<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        size<span class="token operator">:</span> item<span class="token punctuation">.</span>transferSize<span class="token punctuation">,</span>
        protocol<span class="token operator">:</span> item<span class="token punctuation">.</span>nextHopProtocol
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> resource<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="用户行为日志"><a href="#用户行为日志" class="header-anchor">#</a> 用户行为日志</h2> <p>单纯收集错误信息是可以提高错误定位的效率，但如果再配合上用户行为的话就锦上添花，定位错误的效率再上一层，如下图所示，可以清晰的看到用户做了哪些事：进了哪个页面 =&gt; 点击了哪个按钮 =&gt; 触发了哪个接口：</p> <p><img src="/blog/skills/images/user-action.image" alt="breadcrumb"></p> <p>用户行为前端页面展示</p> <h3 id="dom-事件信息"><a href="#dom-事件信息" class="header-anchor">#</a> DOM 事件信息</h3> <p><code>dom</code>事件获取包括很多：<code>click</code>、<code>input</code>、<code>doubleClick</code>等等，一种直接在 window 上面监听 click 事件（注意第三个参数为<code>true</code>）:</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>还有一种是通过重写<code>window.addEventListener</code>的方式来截取开发者对 dom 的监听事件。</p> <h3 id="路由切换信息"><a href="#路由切换信息" class="header-anchor">#</a> 路由切换信息</h3> <p>在单页应用中有两种路由变换：<strong>hashchange</strong>、<strong>history</strong></p> <ul><li><strong>history</strong></li></ul> <p>当浏览器支持<code>history</code>模式时，会被以下两个事件所影响：<code>pushState</code>、<code>replaceState</code>，且这两个事件不会触发<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/onpopstate" target="_blank" rel="noopener noreferrer">onpopstate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的回调，所以我们需要监听这个三个事件：</p> <p><img src="/blog/skills/images/pop-state.image" alt="onpopstate"></p> <p>onpopstate 重写</p> <ul><li><strong>hashchange</strong></li></ul> <p>当浏览器只支持<code>hashchange</code>时，就需要重写 hashchange:</p> <p><img src="/blog/skills/images/hashchange.image" alt="hashchange"></p> <p>hashchange 重写</p> <h3 id="console-信息"><a href="#console-信息" class="header-anchor">#</a> console 信息</h3> <p>正常情况下正式环境是不应该有<code>console</code>的，那为什么要收集<code>console</code>的信息？第一：非正常情况下，正式环境或预发环境也可能会有<code>console</code>，第二：很多时候也可以把<code>sdk</code>放入测试环境上面调试。所以最终还是决定收集<code>console</code>信息，但是在初始化的时候的传参来告诉<code>sdk</code>是否监听<code>console</code>的信息收集。</p> <p><img src="/blog/skills/images/replace-console.image" alt="relaceConsole">
console 重写</p> <h2 id="错误崩溃日志"><a href="#错误崩溃日志" class="header-anchor">#</a> 错误崩溃日志</h2> <p>目前所能捕捉的错误有三种:</p> <ul><li><p>资源加载错误: 通过  <code>addEventListener('error', callback, true)</code>  在捕获阶段捕捉资源加载失败错误。</p></li> <li><p>JS 执行错误: 通过  <code>window.onerror</code>  捕捉 JS 错误。</p></li> <li><p>Promise 错误: 通过  <code>addEventListener('unhandledrejection', callback)</code>捕捉 promise 错误，但是没有发生错误的行数，列数等信息，只能手动抛出相关错误信息。</p></li> <li><p>前端框架类错误: 前端框架如 Angule/Vue/React 的内部错误</p></li> <li><p>页面崩溃错误: 在页面异常退出时的错误</p></li></ul> <p>我们可以建一个错误数组变量  <code>errors</code>  在错误发生时，将错误的相关信息添加到数组，然后在某个阶段统一上报，具体如何操作请看下面的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> monitor <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 静态资源异常监听, 需在捕获阶段获取(请求资源不会冒泡到window)</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span>
  <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> target <span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!==</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      monitor<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> target<span class="token punctuation">.</span>localName<span class="token punctuation">,</span>
        url<span class="token operator">:</span> target<span class="token punctuation">.</span>src <span class="token operator">||</span> target<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target<span class="token punctuation">.</span>src <span class="token operator">||</span> target<span class="token punctuation">.</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is load error</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">true</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 普通js错误</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  monitor<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;javascript&quot;</span><span class="token punctuation">,</span>
    row<span class="token punctuation">,</span>
    col<span class="token punctuation">,</span>
    msg<span class="token operator">:</span> error <span class="token operator">&amp;&amp;</span> error<span class="token punctuation">.</span>stack <span class="token operator">?</span> error<span class="token punctuation">.</span>stack <span class="token operator">:</span> msg<span class="token punctuation">,</span>
    url<span class="token punctuation">,</span>
    time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// promise错误</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  monitor<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;promise&quot;</span><span class="token punctuation">,</span>
    msg<span class="token operator">:</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>reason <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>reason<span class="token punctuation">.</span>msg<span class="token punctuation">)</span> <span class="token operator">||</span> e<span class="token punctuation">.</span>reason <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 跨域脚本错误 &lt;script src=&quot;http://xxx.lorain/main.js&quot; crossorigin&gt;&lt;/script&gt;,我们为 script 标签添加 crossOrigin 属性。</span>
<span class="token comment">// 或者动态去添加 js 脚本</span>
<span class="token comment">// const script = document.createElement(&quot;script&quot;);</span>
<span class="token comment">// script.crossOrigin = &quot;anonymous&quot;;</span>
<span class="token comment">// script.src = url;</span>
<span class="token comment">// document.body.appendChild(script);</span>

<span class="token comment">// 框架错误</span>
<span class="token comment">// Vue异常监听, 7通过, 捕获vue框架的全局错误</span>
Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function-variable function">errorHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;通过vue errorHandler捕获的错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// React错误监听, 在全局应用中使用错误监听组件来包裹</span>
<span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> hasError<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Display fallback UI</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> hasError<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// You can also log the error to an error reporting service</span>
    <span class="token function">logErrorToMyService</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// You can render any custom fallback UI</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Something went wrong<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 崩溃监听, 监听页面是否正常卸载,一般在service worker中监听</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;good_exit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pending&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;time_before_crash&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;beforeunload&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;good_exit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>
  sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;good_exit&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
  sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;good_exit&quot;</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">&quot;true&quot;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* insert crash logging code here */</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在一般的崩溃发生后, 用户会强杀脚本, 导致监听异常</span>
<span class="token comment">// 基于以下原因，我们可以使用 Service Worker 来实现网页崩溃的监控：</span>
<span class="token comment">// Service Worker 有自己独立的工作线程，与网页区分开，网页崩溃了，Service Worker 一般情况下不会崩溃；</span>
<span class="token comment">// Service Worker 生命周期一般要比网页还要长，可以用来监控网页的状态；</span>
<span class="token comment">// 网页可以通过 navigator.serviceWorker.controller.postMessage API 向掌管自己的 SW 发送消息。</span>

<span class="token comment">// 以下是sdk中的崩溃监听心跳代码</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceWorker</span><span class="token punctuation">(</span><span class="token string">&quot;xxxxxx.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">CHECK_CRASH_INTERVAL</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token comment">// 每 10s 检查一次</span>
<span class="token keyword">const</span> <span class="token constant">CRASH_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">15</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token comment">// 15s 超过15s没有心跳则认为已经 crash</span>
<span class="token keyword">const</span> pages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> timer<span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">checkCrash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> id <span class="token keyword">in</span> pages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> page <span class="token operator">=</span> pages<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> page<span class="token punctuation">.</span>t <span class="token operator">&gt;</span> <span class="token constant">CRASH_THRESHOLD</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 上报 crash</span>
      <span class="token keyword">delete</span> pages<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
worker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;heartbeat&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pages<span class="token punctuation">[</span>data<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> t<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">checkCrash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">CHECK_CRASH_INTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;unload&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> pages<span class="token punctuation">[</span>data<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>崩溃监听中<code>service-worker</code>中的代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token constant">HEARTBEAT_INTERVAL</span> <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token comment">// 每五秒发一次心跳</span>
  <span class="token keyword">let</span> sessionId <span class="token operator">=</span> <span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token function-variable function">heartbeat</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;heartbeat&quot;</span><span class="token punctuation">,</span>
      id<span class="token operator">:</span> sessionId<span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

      <span class="token comment">// 附加信息，如果页面 crash，上报的附加数据</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;beforeunload&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;unload&quot;</span><span class="token punctuation">,</span>
      id<span class="token operator">:</span> sessionId
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span>heartbeat<span class="token punctuation">,</span> <span class="token constant">HEARTBEAT_INTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">heartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="其他日志"><a href="#其他日志" class="header-anchor">#</a> 其他日志</h2> <p>这块的日志根据业务具体来定制</p> <h2 id="如何上报"><a href="#如何上报" class="header-anchor">#</a> 如何上报</h2> <p>收集了日志数据之后通过构造一个带参数 URL, 再通过一个 Image 请求发送到到服务器就完成了日志的上报。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/r.png?page=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>location<span class="token punctuation">.</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;param=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>param<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><h2 id="上报的措施"><a href="#上报的措施" class="header-anchor">#</a> 上报的措施</h2> <p>在日志的上报过程中, 需要考虑到的主要是:</p> <ul><li>日志上报可靠性: 设计到浏览器的兼容性,网络未加载成功 SDK 等</li> <li>日志上报的性能: 日志数据可能会非常多，上报可能会因为浏览器并发数量的限制阻塞业务的网络请求，或者影响页面性能</li></ul> <p>综上的问题, 日志上报的手段主要有以下几种</p> <h3 id="_1-隔离业务上报"><a href="#_1-隔离业务上报" class="header-anchor">#</a> 1. 隔离业务上报</h3> <p>一、为了不占用业务计算资源，日志上报需要单独设定后端服务</p> <p>二、浏览器会对同一个域名有一定的并发数限制，日志上报不能使用与业务相同的域名</p> <p>三、不同域名导致跨域, 需要前后端共同支持</p> <blockquote><p>服务器需要允许外部访问 Access-Control-Allow-Origin:*；前端在进行日志上报的时候要添加避免跨域标识</p></blockquote> <p>四、域名不同带来的 DNS 解析延迟，因此需要使用域名预解析</p> <blockquote><link rel="dns-prefetch" href="https://arms-retcode.aliyuncs.com"></blockquote> <p>五、日志上报也可能出现异常, 因此也需要同业务分开</p> <blockquote><p>日志本身抛出的异常绝对不能和业务异常混在一起上报</p> <p>进行充分测试的前提下，最简单粗暴的方式是在整个监控 sdk 外面添加 try...catch..., 好处是永远不会出现 sdk 本身错误上报，不过同时也让开发者失去了发现 sdk 问题的途径。所以两者兼得的方式是必要的。</p></blockquote> <h3 id="_2-压缩请求和响应报文"><a href="#_2-压缩请求和响应报文" class="header-anchor">#</a> 2. 压缩请求和响应报文</h3> <p>在上面提到使用图片及 URL 参数来上报日志, 其实这个方案也有他的缺陷:</p> <h4 id="长度限制-日志上报通过-url-参数传递-url-长度是有限制的"><a href="#长度限制-日志上报通过-url-参数传递-url-长度是有限制的" class="header-anchor">#</a> 长度限制: 日志上报通过 URL 参数传递,URL 长度是有限制的</h4> <p>因此, 可以采用 HTTP2 的头部压缩, <code>JS Error</code>错误栈信息应该使用字符串来保存相同部分, 压缩空间就来源于 stack 中 js 文件的 url 重复。</p> <p>一个典型的 jserror stack 经常会出现这种形式如下：</p> <div class="language-error extra-class"><pre class="language-text"><code>obj0.fn0 at (&lt;http://loooooooooonnnnnnnnnnng/loooooong/long.js&gt; 123:1)

obj1.fn1 at (&lt;http://loooooooooonnnnnnnnnnng/loooooong/long.js&gt; 234:1)

obj2.fn2 at (&lt;http://loooooooooonnnnnnnnnnng/laaaaaang/lang.js&gt; 345:1)

</code></pre></div><p>可考虑把文件 url 抽取出来单独作为一个字典，那么上报内容可缩减为</p> <div class="language-error extra-class"><pre class="language-text"><code>files={'f1':'http://loooooooooonnnnnnnnnnng/loooooong/long.js','f2':'...'}

obj0.fn0 at (f1 123:1)

obj1.fn1 at (f1 234:1)

obj2.fn2 at (f2 345:1)

</code></pre></div><h4 id="上报响应-只需关注日志有没有上报-而对上报请求的返回内容并不关注"><a href="#上报响应-只需关注日志有没有上报-而对上报请求的返回内容并不关注" class="header-anchor">#</a> 上报响应: 只需关注日志有没有上报，而对上报请求的返回内容并不关注</h4> <p>日志上报本身只关注日志有没有上报，而对上报请求的返回内容并不关注，甚至完全可以不需要返回内容。所以使用 HTTP HEAD 的方式上报，并且返回的响应体为空，避免响应体传输资源损耗。</p> <p>这时候只需要设置一个 nginx 服务器来记录日志内容并返回 200 状态码即可。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?t=perf&amp;page=lazada-home&amp;load=1168</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">&quot;no-cors&quot;</span><span class="token punctuation">,</span>
  method<span class="token operator">:</span> <span class="token string">&quot;HEAD&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-合并上报"><a href="#_3-合并上报" class="header-anchor">#</a> 3. 合并上报</h3> <p>页面上报的次数那么多，我们应该是把日志合并上报来减小请求数量</p> <h4 id="开启-http2-使用-http-2-的多路复用来合并上报"><a href="#开启-http2-使用-http-2-的多路复用来合并上报" class="header-anchor">#</a> 开启 Http2, 使用 HTTP/2 的多路复用来合并上报</h4> <p>用户浏览器和日志服务器之间产生多次 HTTP 请求,而在 HTTP/1.1 Keep-Alive 下，日志上报会以串行的方式传输，会让后面的日志上报延时。通过 HTTP/2 的多路复用来合并上报，节省网络连接的开销。</p> <h4 id="http-post-合并"><a href="#http-post-合并" class="header-anchor">#</a> HTTP POST 合并</h4> <p>在 HTTP POST 中只要一次包含多条日志的内容，那么相对于一条日志一次 HTTP HEAD 请求的方式会更加经济; 其次需要解决用户关掉或者切换页面造成的漏报问题</p> <p>常见的方案主要是<code>unload</code>或者<code>beforeUnload</code>事件中进行上报, 上报可以使用同步上报或者<code>navigation.setBeacon</code>进行异步上报</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 同步上报</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unload&quot;</span><span class="token punctuation">,</span> uploadLog<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">uploadLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/xx.png&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false表示同步</span>

  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>logData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 异步上报</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unload&quot;</span><span class="token punctuation">,</span> uploadLog<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">uploadLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span><span class="token string">&quot;/xx.png&quot;</span><span class="token punctuation">,</span> logData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>合并前:</p> <p><img src="/blog/skills/images/log-upload-sync.webp" alt="合并前"></p> <p>合并后:</p> <p><img src="/blog/skills/images/log-upload-async.webp" alt="合并后"></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">4/4/2021, 11:43:43 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/skills/性能优化总结.html" class="prev">
        性能优化总结
      </a></span> <span class="next"><a href="/blog/skills/服务器推送.html">
        服务器推送
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.20bea726.js" defer></script><script src="/blog/assets/js/3.8c44ca0e.js" defer></script><script src="/blog/assets/js/42.65bd37b4.js" defer></script><script src="/blog/assets/js/4.57980df9.js" defer></script>
  </body>
</html>
